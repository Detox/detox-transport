/*
 0BSD
*/
(function(){function t(e,l){e[0]=e[1];e[1]=e[2];e[2]=e[3];e[3]=e[4];e[4]=l}function m(e,m,p,u,x,y){function h(a,c,b,d,f,v){if(!(this instanceof h))return new h(a,c,b,d,f,v);p.call(this);this.w=a;this.g=c;this.F=d;this.i=v;this.B=1E3/f;this.o=m.Multiplexer(l,q);this.f=m.Demultiplexer(l,q);this.v=[g,g,g,g,g];this.u=[g,g,g,g,g];this.j(b)}function k(a,c,b,d,f){if(!(this instanceof k))return new k(a,c,b,d,f);p.call(this);this.j=a;this.a=w();this.c=w();this.g=new Set;this.i=c;this.o=b;this.l=d;this.m=f;
this.f=new WeakMap}var z=e.array2string;var A=e.string2array;var n=e.concat_arrays;var B=e.error_handler;var w=e.ArrayMap;var C=e.timeoutSet;var g=new Uint8Array(0);h.prototype={j:function(a){var c,b=this;if(!this.A){this.c=this.l=a;var d=this.a;var f=c=x({config:{iceServers:this.F},initiator:a,trickle:!1,wrtc:y});f.once("signal",function(d){b.b||b.a!==c||b.fire("signal",n([[a?1:0],A(d.sdp)]))});f.once("connect",function(){b.b||b.a!==c||(b.fire("connected"),b.off("signal"),b.A=!0,b.m=+new Date,b.c&&
b.s())});f.once("close",function(){b.a===c&&(b.fire("disconnected"),b.destroy())});f.on("data",function(a){if(!b.b)if(b.c||a.length!==q)b.destroy();else{for(b.f.feed(a);b.f.have_more_data();){var c=b.f.get_data();a=c[0];c=c.subarray(1);a<b.i&&(c=b.D(c));b.fire("data",a,c)}b.c=!0;b.s()}});f.on("error",B);this.a=c;d&&d.destroy()}},signal:function(a){var c,b;if(!this.b){if(!!a[0]===this.l){var d=0;for(b=(c=this.w).length;d<b;++d){var f=d;var e=c[d];if(e!==this.g[f]){if(e>this.g[f])return;this.j(!1);
break}}}this.a.signal({type:this.l?"answer":"offer",sdp:z(a.subarray(1))})}},update_peer_id:function(a){this.g=a},send:function(a,c){if(!(this.b||c.length>l)){if(a<this.i){if(c.length>r)return;c=this.C(c)}a=n([[a],c]);this.o.feed(a)}},destroy:function(){this.b||(this.b=!0,clearTimeout(this.h),this.a.destroy())},s:function(){var a=this;this.h=setTimeout(function(){if(!a.b)try{a.a.send(a.o.get_block()),a.c=!1,a.m=+new Date}catch(c){}},Math.max(0,this.B-(new Date-this.m)))},C:function(a){var c=u.deflate(a,
{dictionary:n(this.v),level:1});t(this.v,a);return c.length>r?n([[0],a]):n([[1],c])},D:function(a){var c;var b=a[0];a=a.subarray(1);b?c=u.inflate(a,{dictionary:n(this.u)}):c=a;t(this.u,c);return c}};h.prototype=Object.assign(Object.create(p.prototype),h.prototype);Object.defineProperty(h.prototype,"constructor",{value:h});k.prototype={create_connection:function(a,c){var b,d=this;if(this.b)return null;if(b=this.a.get(c)||this.c.get(c))return b;b=h(this.j,c,a,this.i,this.o,this.l).on("data",function(a,
c){if(!d.b){var f=d.f.get(b);d.fire("data",f,a,c)}}).once("signal",function(a){if(!d.b){var c=d.f.get(b);d.fire("signal",c,a);d.h(b,"connected")}}).once("connected",function(){var a=d.f.get(b);!d.b&&d.a.has(a)&&(d.a["delete"](a),d.c.set(a,b),d.fire("connected",a))}).once("disconnected",function(){if(!d.b){var a=d.f.get(b);d.a["delete"](a);d.c["delete"](a);d.fire("disconnected",a)}});this.f.set(b,c);this.h(b,"signal");this.a.set(c,b);return b},update_peer_id:function(a,c){var b;return this.a.has(c)||
this.c.has(c)?!1:(b=this.a.get(a))?(this.f.set(b,c),this.a["delete"](a),this.a.set(c,b),b.update_peer_id(c),!0):(b=this.c.get(a))?(this.f.set(b,c),this.c["delete"](a),this.c.set(c,b),b.update_peer_id(c),!0):!1},h:function(a,c){var b=this;var d=C(this.m,function(){a.destroy()});this.g.add(d);a.once(c,function(){b.g["delete"](d);clearTimeout(d)})},destroy_connection:function(a){(a=this.a.get(a)||this.c.get(a))&&a.destroy()},signal:function(a,c){this.b||(a=this.a.get(a))&&a.signal(c)},send:function(a,
c,b){this.b||(a=this.c.get(a))&&a.send(c,b)},destroy:function(){this.b||(this.b=!0,this.a.forEach(function(a){a.destroy()}),this.c.forEach(function(a){a.destroy()}),this.g.forEach(function(a){clearTimeout(a)}))}};k.prototype=Object.assign(Object.create(p.prototype),k.prototype);Object.defineProperty(k.prototype,"constructor",{value:k});return{P2P_transport:h,Transport:k,MAX_DATA_SIZE:l,MAX_COMPRESSED_DATA_SIZE:r}}var l=Math.pow(2,16)-2;var r=l-1;var q=512;"function"===typeof define&&define.amd?define(["@detox/utils",
"fixed-size-multiplexer","async-eventer","pako","@detox/simple-peer"],m):"object"===typeof exports?module.exports=m(require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer"),require("pako"),require("@detox/simple-peer"),require("wrtc")):this.detox_transport=m(this.detox_utils,this.fixed_size_multiplexer,this.async_eventer,this.pako,this.SimplePeer)}).call(this);