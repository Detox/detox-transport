/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(){function D(h){var c;var l="";var n=0;for(c=h.length;n<c;++n){var q=h[n];l+=q.toString(16).padStart(2,"0")}return l}function G(h){var c;var l=new Uint8Array(h.length/2);var n=0;for(c=l.length;n<c;++n){var q=n;l[q]=parseInt(h.substring(2*q,2*q+2),16)}return l}function H(h){var c;var l=new Uint8Array(h.length);var n=0;for(c=h.length;n<c;++n){var q=n;l[q]=h.charCodeAt(q)}return l}function v(h,c){return h.join(",")+c.join(",")}function z(h,c,l,n,q,B){function y(a){var b=this;if(!(this instanceof
y))return new y(a);this.G=a.sign;this.i=a.packets_per_second;this.o=a.initiator;this.once("connect",function(){b.F=1E3/b.i;b.h=q.Multiplexer(A,C);b.c=q.Demultiplexer(A,C);b.A=+new Date;b.o&&b.B()});p.call(this,a)}function z(a){var b=new n("SHA3-256","ARRAYBUFFER");b.update(a);return w.from(b.getHash("ARRAYBUFFER"))}function t(a,b,e,d,u,m){var g=this;null==m&&(m=2);if(!(this instanceof t))return new t(a,b,e,d,u,m);B.call(this);1>u&&(u=1);this.i=new Map;d=this.b=M({simple_peer_constructor:y,simple_peer_opts:{config:{iceServers:d},
packets_per_second:u,sign:function(d){return h.sign(d,a,b)}}});d.on("websocket_peer_connection_alias",function(a,b,d){e.forEach(function(f){if(f.host===a&&f.port===b)return g.i.set(d,f.node_id),d.on("close",function(){g.i["delete"](d)})})});d.on("node_connected",function(a){var b=G(a);var d=g.b.get_id_mapping(a);if(g.i.has(d)){var e=g.i.get(d);g.i["delete"](d);if(e!==a){d.destroy();return}}h.verify(d.H,d.D,b)?(d.on("custom_data",function(d,e){switch(d){case I:g.b.add_tag(a,"detox-responder");g.fire("node_tagged",
b);break;case J:g.b.del_tag(a,"detox-responder");g.fire("node_untagged",b);break;default:d<E||g.fire("data",b,d-E,e)}}),g.fire("node_connected",b)):d.destroy()});d.on("node_disconnected",function(a){g.fire("node_disconnected",G(a))});m=this.f=new O({bootstrap:e,hash:z,k:m,nodeId:w.from(a),socket:this.b,timeout:1E3*P,verify:h.verify});m.on("error",function(a){g.fire("error",a)});m.once("ready",function(){g.fire("ready")})}function x(a,b){var e=this;null==b&&(b=10);if(!(this instanceof x))return new x(a,
b);B.call(this);this.g=new Map;this.m=new Map;this.j=new Map;this.h=new Map;this.c=new Map;this.u=new Map;this.a=l(Q,R,r,S,b).on("activity",function(a,b){e.fire("activity",a,b)}).on("create_request",function(b,u,m){var d=v(b,u);if(!e.g.has(d)){var f=h.Encryptor(!1,a);try{f.put_handshake_message(m)}catch(N){return}e.a.create_response(b,u,f.get_handshake_message());e.a.confirm_incoming_segment_established(b,u);e.h.set(d,q.Multiplexer(A,e.l));e.c.set(d,q.Demultiplexer(A,e.l));if(f.ready()){u=f.get_rewrapper_keys().map(h.Rewrapper);
m=b.join(",");var c=Object.create(null);c[m]=f;f=Object.create(null);f[m]=u;e.g.set(d,c);e.m.set(d,f);e.j.set(d,b)}}}).on("send",function(a,b){e.fire("send",a,b)}).on("data",function(a,b,c,g,f){var d=v(a,b);var u=e.j.get(d);c.join(",")===u.join(",")&&(c=e.c.get(d))&&(c.feed(f),c.have_more_data()&&(f=c.get_data(),e.fire("data",a,b,g,f)))}).on("encrypt",function(a){var b;var d=a.address;var c=a.segment_id;var f=a.target_address;var k=a.plaintext;d=v(d,c);f=f.join(",");(f=null!=(b=e.g.get(d))?b[f]:void 0)&&
(a.ciphertext=f.encrypt(k))}).on("decrypt",function(a){var b;var d=a.address;var c=a.segment_id;var f=a.target_address;var k=a.ciphertext;d=v(d,c);f=f.join(",");if(f=null!=(b=e.g.get(d))?b[f]:void 0)try{a.plaintext=f.decrypt(k)}catch(N){}}).on("wrap",function(a){var b,d;var c=a.address;var f=a.segment_id;var k=a.target_address;var h=a.unwrapped;c=v(c,f);k=k.join(",");(k=null!=(b=e.m.get(c))?null!=(d=b[k])?d[0]:void 0:void 0)&&(a.wrapped=k.wrap(h))}).on("unwrap",function(a){var b,d;var c=a.address;
var f=a.segment_id;var k=a.target_address;var h=a.wrapped;c=v(c,f);k=k.join(",");(k=null!=(b=e.m.get(c))?null!=(d=b[k])?d[1]:void 0:void 0)&&(a.unwrapped=k.unwrap(h))});this.l=this.a.get_max_command_data_length()}var F=c.bencode;var p=c["simple-peer"];var M=c["webrtc-socket"];var O=c["webtorrent-dht"];var w=c.Buffer;y.prototype=Object.create(p.prototype);c=y.prototype;c.emit=function(a,b){switch(a){case "signal":b.signature=w.from(this.G(H(b.sdp)));p.prototype.emit.call(this,"signal",b);break;case "data":if(this.o)this.destroy();
else if(b.length!==C)this.destroy();else{for(this.c.feed(b);this.c.have_more_data();){var c=this.c.get_data();var d=c[0];d===K?p.prototype.emit.call(this,"data",w.from(c.subarray(1))):p.prototype.emit.call(this,"custom_data",d,c.subarray(1))}this.o=!0;this.B()}break;default:p.prototype.emit.apply(this,arguments)}};c.signal=function(a){a.signature?(this.H=a.signature,this.D=H(a.sdp),p.prototype.signal.call(this,a)):this.destroy()};c.send=function(a){this.C(a,K)};c.w=function(a,b){this.C(a,b)};c.C=
function(a,b){var c;var d=c=new Uint8Array(a.length+1);d.set([b]);d.set(a,1);this.h.feed(c)};c.B=function(){var a=this;setTimeout(function(){a.destroyed||(p.prototype.send.call(a,a.h.get_block()),a.o=!1,a.A=+new Date)},Math.max(0,this.F-(new Date-this.A)))};Object.defineProperty(y.prototype,"constructor",{enumerable:!1,value:y});t.prototype=Object.create(B.prototype);c=t.prototype;c.start_bootstrap_node=function(a,b){this.f.listen(b,a)};c.get_bootstrap_nodes=function(){var a,b,c=[];for(a in b=this.f._rpc.socket.socket._peer_connections){var d=
b[a];d.ws_server&&d.id&&c.push({node_id:d.id,host:d.ws_server.host,port:d.ws_server.port})}return c.filter(Boolean)};c.lookup=function(a){this.f.lookup(w.from(a))};c.add_used_tag=function(a){var b;a=D(a);if(b=this.b.get_id_mapping(a))b.w(new Uint8Array(0),I),this.b.add_tag(a,"detox-initiator")};c.del_used_tag=function(a){var b;a=D(a);if(b=this.b.get_id_mapping(a))b.w(new Uint8Array(0),J),this.b.del_tag(a,"detox-initiator")};c.send_data=function(a,b,c){c.length>A||(a=this.b.get_id_mapping(D(a)))&&
a.w(c,b+E)};c.generate_announcement_message=function(a,b,c){var d;var e=+new Date;var m=new Uint8Array(c.length*r);var g=0;for(d=c.length;g<d;++g){var f=g;var k=c[g];m.set(k,f*r)}c=F.encode({seq:e,v:w.from(m)}).slice(1,-1);b=h.sign(c,a,b);return Uint8Array.from(F.encode({k:w.from(a),seq:e,sig:w.from(b),v:w.from(m)}))};c.publish_announcement_message=function(a){try{a=F.decode(w.from(a))}catch(b){}a&&a.k&&a.seq&&a.sig&&a.v&&this.f.put(a)};c.find_introduction_nodes=function(a,b,c){a=z(a);this.f.get(a,
function(a,e){var d;if(e&&e.v){if(a=Uint8Array.from(e.v),e=[],0===a.length%r){var g=0;for(d=a.length/r;g<d;++g){var f=g;e.push(a.subarray(f*r,(f+1)*r))}b(e)}}else c()})};c.destroy=function(a){this.f.destroy(a);delete this.f};Object.defineProperty(t.prototype,"constructor",{enumerable:!1,value:t});x.prototype=Object.create(B.prototype);c=x.prototype;c.process_packet=function(a,b){this.a.process_packet(a,b)};c.construct_routing_path=function(a){var b=this;a=a.slice();return new Promise(function(c){function d(e,
m,u){function v(){function d(a,c,e){if(f===a.join(",")&&y===c.join(",")){b.a.off("extend_response",d);clearTimeout(z);e.length||l();try{k[r].put_handshake_message(e)}catch(U){l()}k[r].ready()||l();n[r]=k[r].get_rewrapper_keys().map(h.Rewrapper);b.a.confirm_extended_path(g,p);v()}}var e;a.length?(b.a.on("extend_response",d),x=a.shift(),r=x.join(","),(e=h.convert_public_key(x))||l(),k[r]=h.Encryptor(!0,e),z=setTimeout(function(){b.a.off("extend_response",d);l()},1E3*L),b.a.extend_request(g,p,x,k[r].get_handshake_message())):
(b.u.set(t,[g,p]),c(p))}var x,r,z;if(f===e.join(",")&&y===m.join(",")){clearTimeout(w);b.a.off("create_response",d);try{k[f].put_handshake_message(u)}catch(T){l()}k[f].ready()||l();n[f]=k[f].get_rewrapper_keys().map(h.Rewrapper);b.a.confirm_outgoing_segment_established(g,p);b.h.set(t,q.Multiplexer(A,b.l));b.c.set(t,q.Demultiplexer(A,b.l));v()}}var e;var m=a[a.length-1];var g=a.shift();var f=g.join(",");var k=Object.create(null);var n=Object.create(null);var l=function(){b.s(g,p);throw Error("Routing path creation failed");
};(e=h.convert_public_key(g))||l();k[f]=h.Encryptor(!0,e);b.a.on("create_response",d);var w=setTimeout(function(){b.a.off("create_response",d);l()},1E3*L);var p=b.a.create_request(g,k[f].get_handshake_message());var y=p.join(",");var t=v(g,p);b.g.set(t,k);b.m.set(t,n);b.j.set(t,m)})};c.destroy_routing_path=function(a,b){this.s(a,b)};c.get_max_packet_data_size=function(){return this.l};c.send_data=function(a,b,c,d){if(!(d.length>A)){var e=v(a,b);var h=this.j.get(e);if(e=this.h.get(e))for(e.feed(d);e.have_more_blocks();)d=
e.get_block(),this.a.data(a,b,h,c,d)}};c.destroy=function(){var a=this;this.u.forEach(function(b){a.s(b[0],b[1])})};c.s=function(a,b){var c;a=v(a,b);if(b=this.g.get(a)){for(c in b){var d=b[c];d.destroy()}this.g["delete"](a);this.m["delete"](a);this.j["delete"](a);this.h["delete"](a);this.c["delete"](a);this.u["delete"](a)}};Object.defineProperty(x.prototype,"constructor",{enumerable:!1,value:x});return{ready:h.ready,DHT:t,Router:x,MAX_DATA_SIZE:A}}var K=0;var I=1;var J=2;var E=10;var Q=0;var r=32;
var S=16;var L=10;var A=Math.pow(2,16)-1;var C=512;var R=C-3;var P=30;"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht ronion jssha/src/sha3 fixed-size-multiplexer async-eventer".split(" "),z):"object"===typeof exports?module.exports=z(require("@detox/crypto"),require("@detox/dht"),require("ronion"),require("jssha/src/sha3"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_transport=z(this.detox_crypto,this.detox_dht,this.ronion,this.jsSHA,this.fixed_size_multiplexer,
this.async_eventer)}).call(this);