/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(){function E(h){var e;var u="";var n=0;for(e=h.length;n<e;++n){var r=h[n];u+=r.toString(16).padStart(2,"0")}return u}function G(h){var e;var u=new Uint8Array(h.length/2);var n=0;for(e=u.length;n<e;++n){var r=n;u[r]=parseInt(h.substring(2*r,2*r+2),16)}return u}function H(h){var e;var u=new Uint8Array(h.length);var n=0;for(e=h.length;n<e;++n){var r=n;u[r]=h.charCodeAt(r)}return u}function p(h,e){return h.join(",")+e.join(",")}function B(h,e,u,n,r,D){function t(b){var a=this;if(!(this instanceof
t))return new t(b);this.I=b.sign;this.i=b.packet_size;this.A=b.packets_per_second;this.u=b.initiator;this.once("connect",function(){a.H=1E3/a.A;a.h=r.Multiplexer(A,a.i);a.c=r.Demultiplexer(A,a.i);a.C=+new Date;a.u&&a.D()});v.call(this,b)}function B(b){var a=new n("SHA3-256","ARRAYBUFFER");a.update(b);return m.from(a.getHash("ARRAYBUFFER"))}function w(b,a,f,d,c,x,l){var g=this;null==l&&(l=2);if(!(this instanceof w))return new w(b,a,f,d,c,x,l);if(c<C)throw Error("Minimal supported packet size is "+
C);D.call(this);1>x&&(x=1);this.m=new Map;var k=["psr:"+c+":"+x];d=this.b=M({extensions:k,simple_peer_constructor:t,simple_peer_opts:{config:{iceServers:d},packet_size:c,packets_per_second:x,sign:function(c){return h.sign(c,b,a)}}});d.on("websocket_peer_connection_alias",function(b,c,a){f.forEach(function(d){if(d.host===b&&d.port===c)return g.m.set(a,d.node_id),a.on("close",function(){g.m["delete"](a)})})});d.on("node_connected",function(b){var c=G(b);var a=g.b.get_id_mapping(b);if(g.m.has(a)){var d=
g.m.get(a);g.m["delete"](a);if(d!==b){a.destroy();return}}h.verify(a.J,a.G,c)?(a.on("custom_data",function(a,d){switch(a){case I:g.b.add_tag(b,"detox-responder");g.fire("node_tagged",c);break;case J:g.b.del_tag(b,"detox-responder");g.fire("node_untagged",c);break;default:a<F||g.fire("data",c,a-F,d)}}),g.fire("node_connected",c)):a.destroy()});d.on("node_disconnected",function(b){g.fire("node_disconnected",G(b))});l=this.f=new N({bootstrap:f,extensions:k,hash:B,k:l,nodeId:m.from(b),socket:this.b,timeout:1E3*
O,verify:h.verify});l.on("error",function(b){g.fire("error",b)});l.once("ready",function(){g.fire("ready")})}function y(b,a,f){var d=this;null==f&&(f=10);if(!(this instanceof y))return new y(b,a,f);if(a<C)throw Error("Minimal supported packet size is "+C);D.call(this);this.g=new Map;this.l=new Map;this.j=new Map;this.h=new Map;this.c=new Map;this.w=new Map;this.a=u(P,a-3,z,Q,f).on("create_request",function(a){var c=a.address;var l=a.segment_id;var g=a.command_data;a=p(c,l);if(!d.g.has(a)){var k=h.Encryptor(!1,
b);try{k.put_handshake_message(g)}catch(q){return}d.a.create_response(c,l,k.get_handshake_message());d.a.confirm_incoming_segment_established(c,l);d.h.set(a,r.Multiplexer(A,d.s));d.c.set(a,r.Demultiplexer(A,d.s));if(k.ready()){l=k.get_rewrapper_keys().map(h.Rewrapper);g=c.join(",");var f=Object.create(null);f[g]=k;k=Object.create(null);k[g]=l;d.g.set(a,f);d.l.set(a,k);d.j.set(a,c)}}}).on("send",function(a){d.fire("send",a.address,a.packet)}).on("data",function(a){var b=a.address;var c=a.segment_id;
var g=a.target_address;a=a.command_data;var k=p(b,c);var f=d.j.get(k);g.join(",")===f.join(",")&&(g=d.c.get(k))&&(g.feed(a),g.have_more_data()&&(a=g.get_data(),d.fire("data",b,c,a)))}).on("destroy",function(a){var b=a.address;a=a.segment_id;d.o(b,a);d.fire("destroyed",b,a)}).on("encrypt",function(a){var b;var c=a.address;var g=a.segment_id;var f=a.target_address;var e=a.plaintext;c=p(c,g);f=f.join(",");(f=null!=(b=d.g.get(c))?b[f]:void 0)&&(a.ciphertext=f.encrypt(e))}).on("decrypt",function(a){var b;
var c=a.address;var g=a.segment_id;var f=a.target_address;var e=a.ciphertext;c=p(c,g);f=f.join(",");if(f=null!=(b=d.g.get(c))?b[f]:void 0)try{a.plaintext=f.decrypt(e)}catch(q){}}).on("wrap",function(a){var b,c;var f=a.address;var e=a.segment_id;var h=a.target_address;var q=a.unwrapped;f=p(f,e);h=h.join(",");(h=null!=(b=d.l.get(f))?null!=(c=b[h])?c[0]:void 0:void 0)&&(a.wrapped=h.wrap(q))}).on("unwrap",function(a){var b,c;var f=a.address;var e=a.segment_id;var h=a.target_address;var q=a.wrapped;f=
p(f,e);h=h.join(",");(h=null!=(b=d.l.get(f))?null!=(c=b[h])?c[1]:void 0:void 0)&&(a.unwrapped=h.unwrap(q))});this.s=this.a.get_max_command_data_length()}var R=e.bencode;var v=e["simple-peer"];var M=e["webrtc-socket"];var N=e["webtorrent-dht"];var m=e.Buffer;t.prototype=Object.create(v.prototype);e=t.prototype;e.emit=function(b,a){switch(b){case "signal":a.signature=m.from(this.I(H(a.sdp)));v.prototype.emit.call(this,"signal",a);break;case "data":if(this.u)this.destroy();else if(a.length!==this.i)this.destroy();
else{for(this.c.feed(a);this.c.have_more_data();){var f=this.c.get_data();var d=f[0];d===K?v.prototype.emit.call(this,"data",m.from(f.subarray(1))):v.prototype.emit.call(this,"custom_data",d,f.subarray(1))}this.u=!0;this.D()}break;default:v.prototype.emit.apply(this,arguments)}};e.signal=function(b){var a,f;if(b.signature&&b.extensions){this.J=b.signature;this.G=H(b.sdp);var d=!1;var c=0;for(f=(a=b.extensions).length;c<f;++c){var e=a[c];if(e.startsWith("psr:")){c=e.split(":");d=parseInt(c[1],10);
c=parseInt(c[2],10);if(d<C||1>c){this.destroy();return}this.i=Math.min(this.i,d);this.A=Math.min(this.A,c);d=!0;break}}d?v.prototype.signal.call(this,b):this.destroy()}else this.destroy()};e.send=function(b){this.F(b,K)};e.B=function(b,a){this.F(b,a)};e.F=function(b,a){var f;var d=f=new Uint8Array(b.length+1);d.set([a]);d.set(b,1);this.h.feed(f)};e.D=function(){var b=this;setTimeout(function(){b.destroyed||(v.prototype.send.call(b,b.h.get_block()),b.u=!1,b.C=+new Date)},Math.max(0,this.H-(new Date-
this.C)))};Object.defineProperty(t.prototype,"constructor",{enumerable:!1,value:t});w.prototype=Object.create(D.prototype);e=w.prototype;e.start_bootstrap_node=function(b,a){this.f.listen(a,b)};e.get_bootstrap_nodes=function(){var b,a,f=[];for(b in a=this.f._rpc.socket.socket._peer_connections){var d=a[b];d.ws_server&&d.id&&f.push({node_id:d.id,host:d.ws_server.host,port:d.ws_server.port})}return f.filter(Boolean)};e.lookup=function(b){this.f.lookup(m.from(b))};e.add_used_tag=function(b){var a;b=
E(b);if(a=this.b.get_id_mapping(b))a.B(new Uint8Array(0),I),this.b.add_tag(b,"detox-initiator")};e.del_used_tag=function(b){var a;b=E(b);if(a=this.b.get_id_mapping(b))a.B(new Uint8Array(0),J),this.b.del_tag(b,"detox-initiator")};e.send_data=function(b,a,f){f.length>this.i||(b=this.b.get_id_mapping(E(b)))&&b.B(f,a+F)};e.generate_introduction_message=function(b,a,f){var d;var c=+new Date;var e=new Uint8Array(f.length*z);var l=0;for(d=f.length;l<d;++l){var g=l;var k=f[l];e.set(k,g*z)}f=R.encode({seq:c,
v:m.from(e)}).slice(1,-1);a=h.sign(f,b,a);return{k:b,seq:c,sig:a,v:e}};e.publish_introduction_message=function(b){b.k&&b.seq&&b.sig&&b.v&&this.f.put({k:m.from(b.k),seq:parseInt(b.seq,10),sig:m.from(b.sig),v:m.from(b.v)})};e.find_introduction_nodes=function(b,a,f){b=B(b);this.f.get(b,function(b,c){var d;if(c&&c.v){if(b=Uint8Array.from(c.v),c=[],0===b.length%z){var e=0;for(d=b.length/z;e<d;++e){var g=e;c.push(b.subarray(g*z,(g+1)*z))}a(c)}}else f()})};e.destroy=function(b){this.f.destroy(b);delete this.f};
Object.defineProperty(w.prototype,"constructor",{enumerable:!1,value:w});y.prototype=Object.create(D.prototype);e=y.prototype;e.process_packet=function(b,a){this.a.process_packet(b,a)};e.construct_routing_path=function(b){var a=this;b=b.slice();return new Promise(function(f){function d(c){function e(){function c(b){var d=b.address;var f=b.segment_id;b=b.command_data;if(g===d.join(",")&&v===f.join(",")){a.a.off("extend_response",c);clearTimeout(w);b.length||q();try{k[p].put_handshake_message(b)}catch(T){q()}k[p].ready()||
q();n[p]=k[p].get_rewrapper_keys().map(h.Rewrapper);a.a.confirm_extended_path(l,m);e()}}var d;b.length?(a.a.on("extend_response",c),x=b.shift(),p=x.join(","),(d=h.convert_public_key(x))||q(),k[p]=h.Encryptor(!0,d),w=setTimeout(function(){a.a.off("extend_response",c);q()},1E3*L),a.a.extend_request(l,m,x,k[p].get_handshake_message())):(a.w.set(t,[l,m]),f(m))}var x,p,w;var y=c.address;var z=c.segment_id;c=c.command_data;if(g===y.join(",")&&v===z.join(",")){clearTimeout(u);a.a.off("create_response",d);
try{k[g].put_handshake_message(c)}catch(S){q()}k[g].ready()||q();n[g]=k[g].get_rewrapper_keys().map(h.Rewrapper);a.a.confirm_outgoing_segment_established(l,m);a.h.set(t,r.Multiplexer(A,a.s));a.c.set(t,r.Demultiplexer(A,a.s));e()}}var c;var e=b[b.length-1];var l=b.shift();var g=l.join(",");var k=Object.create(null);var n=Object.create(null);var q=function(){a.o(l,m);throw Error("Routing path creation failed");};(c=h.convert_public_key(l))||q();k[g]=h.Encryptor(!0,c);a.a.on("create_response",d);var u=
setTimeout(function(){a.a.off("create_response",d);q()},1E3*L);var m=a.a.create_request(l,k[g].get_handshake_message());var v=m.join(",");var t=p(l,m);a.g.set(t,k);a.l.set(t,n);a.j.set(t,e)})};e.destroy_routing_path=function(b,a){this.o(b,a)};e.send_data=function(b,a,f){if(!(f.length>A)){var d=p(b,a);var c=this.j.get(d);if(d=this.h.get(d))for(d.feed(f);d.have_more_blocks();)f=d.get_block(),this.a.data(b,a,c,f)}};e.destroy=function(){var b=this;this.w.forEach(function(a){b.o(a[0],a[1])})};e.o=function(b,
a){function f(){var g,k;if(h){--h;try{c.a.destroy(b,a),c.a.once("send",function(){f()})}catch(q){f()}}else{for(g in k=d){var l=k[g];l.destroy()}c.g["delete"](e);c.l["delete"](e);c.j["delete"](e);c.h["delete"](e);c.c["delete"](e);c.w["delete"](e)}}var d,c=this;var e=p(b,a);if(d=this.g.get(e)){var h=Object.keys(d).length;f()}};Object.defineProperty(y.prototype,"constructor",{enumerable:!1,value:y});return{ready:h.ready,DHT:w,Router:y,MAX_DATA_SIZE:A}}var K=0;var I=1;var J=2;var F=10;var P=0;var z=32;
var Q=16;var C=256;var L=10;var A=Math.pow(2,16)-1;var O=30;"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht ronion jssha/src/sha3 fixed-size-multiplexer async-eventer".split(" "),B):"object"===typeof exports?module.exports=B(require("@detox/crypto"),require("@detox/dht"),require("ronion"),require("jssha/src/sha3"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_transport=B(this.detox_crypto,this.detox_dht,this.ronion,this.jsSHA,this.fixed_size_multiplexer,
this.async_eventer)}).call(this);