/*
 0BSD
*/
(function(){function r(c,k){c[0]=c[1];c[1]=c[2];c[2]=c[3];c[3]=c[4];c[4]=k}function l(c,l,n,t,v,w){function g(a,b,d,c){var e=this;if(!(this instanceof g))return new g(a,b,d,c);n.call(this);this.o=a;this.g=c;this.b=v({config:{iceServers:b},initiator:a,trickle:!1,wrtc:w});this.s=1E3/d;this.c=a;this.i=l.Multiplexer(k,p);this.f=l.Demultiplexer(k,p);this.m=[f,f,f,f,f];this.l=[f,f,f,f,f];a=this.b;a.once("signal",function(a){e.a||e.fire("signal",x(a.sdp))});a.once("connect",function(){e.a||(e.fire("connected"),
e.h=+new Date,e.c&&e.j())});a.once("close",function(){e.fire("disconnected")});a.on("data",function(a){if(!e.a)if(e.c||a.length!==p)e.destroy();else{for(e.f.feed(a);e.f.have_more_data();){var b=e.f.get_data();a=b[0];b=b.subarray(1);a<e.g&&(b=e.w(b));e.fire("data",a,b)}e.c=!0;e.j()}})}function h(a,b,d,c){if(!(this instanceof h))return new h(a,b,d,c);n.call(this);this.b=u();this.c=u();this.f=new Set;this.j=a;this.l=b;this.h=d;this.i=c}var y=c.array2string;var x=c.string2array;var m=c.concat_arrays;
var u=c.ArrayMap;var z=c.timeoutSet;var f=new Uint8Array(0);g.prototype={signal:function(a){this.a||this.b.signal({type:this.o?"answer":"offer",sdp:y(a)})},send:function(a,b){if(!(this.a||b.length>k)){if(a<this.g){if(b.length>q)return;b=this.v(b)}a=m([[a],b]);this.i.feed(a)}},destroy:function(){this.a||(this.a=!0,clearTimeout(this.u),this.b.destroy())},j:function(){var a=this;this.u=setTimeout(function(){if(!a.a)try{a.b.send(a.i.get_block()),a.c=!1,a.h=+new Date}catch(b){}},Math.max(0,this.s-(new Date-
this.h)))},v:function(a){var b=t.deflate(a,{dictionary:m(this.m),level:1});r(this.m,a);return b.length>q?m([[0],a]):m([[1],b])},w:function(a){var b;var d=a[0];a=a.subarray(1);d?b=t.inflate(a,{dictionary:m(this.l)}):b=a;r(this.l,b);return b}};g.prototype=Object.assign(Object.create(n.prototype),g.prototype);Object.defineProperty(g.prototype,"constructor",{value:g});h.prototype={create_connection:function(a,b){var d=this;if(!(this.a||this.b.has(b)||this.c.has(b))){var c=g(a,this.j,this.l,this.h).on("data",
function(a,c){d.a||d.fire("data",b,a,c)}).once("signal",function(a){d.a||(d.fire("signal",b,a),d.g(c))}).once("connected",function(){!d.a&&d.b.has(b)&&(d.b["delete"](b),d.c.set(b,c),d.fire("connected",b))}).once("disconnected",function(){d.a||(d.b["delete"](b),d.c["delete"](b),d.fire("disconnected",b))});a||this.g(c);this.b.set(b,c)}},g:function(a){var b=this;var c=z(this.i,function(){a.destroy()});this.f.add(c);a.once("connected",function(){b.f["delete"](c);clearTimeout(c)})},destroy_connection:function(a){(a=
this.b.get(a)||this.c.get(a))&&a.destroy()},signal:function(a,b){this.a||(a=this.b.get(a))&&a.signal(b)},send:function(a,b,c){this.a||(a=this.c.get(a))&&a.send(b,c)},destroy:function(){this.a||(this.a=!0,this.b.forEach(function(a){a.destroy()}),this.c.forEach(function(a){a.destroy()}),this.f.forEach(function(a){clearTimeout(a)}))}};h.prototype=Object.assign(Object.create(n.prototype),h.prototype);Object.defineProperty(h.prototype,"constructor",{value:h});return{P2P_transport:g,Transport:h,MAX_DATA_SIZE:k,
MAX_COMPRESSED_DATA_SIZE:q}}var k=Math.pow(2,16)-2;var q=k-1;var p=512;"function"===typeof define&&define.amd?define(["@detox/utils","fixed-size-multiplexer","async-eventer","pako","@detox/simple-peer"],l):"object"===typeof exports?module.exports=l(require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer"),require("pako"),require("@detox/simple-peer"),require("wrtc")):this.detox_transport=l(this.detox_utils,this.fixed_size_multiplexer,this.async_eventer,this.pako,this.SimplePeer)}).call(this);