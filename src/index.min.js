/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(){function E(f){var c;var u="";var n=0;for(c=f.length;n<c;++n){var r=f[n];u+=r.toString(16).padStart(2,"0")}return u}function F(f){var c;var u=new Uint8Array(f.length/2);var n=0;for(c=u.length;n<c;++n){var r=n;u[r]=parseInt(f.substring(2*r,2*r+2),16)}return u}function G(f){var c;var u=new Uint8Array(f.length);var n=0;for(c=f.length;n<c;++n){var r=n;u[r]=f.charCodeAt(r)}return u}function p(f,c){return f.join(",")+c.join(",")}function A(f,c,u,n,r,D){function t(b){var a=this;if(!(this instanceof
t))return new t(b);this.I=b.sign;this.f=b.packet_size;this.A=b.packets_per_second;this.u=b.initiator;this.once("connect",function(){a.H=1E3/a.A;a.i=r.Multiplexer(a.f,a.f);a.c=r.Demultiplexer(a.f,a.f);a.C=+new Date;a.u&&a.D()});v.call(this,b)}function A(b){var a=new n("SHA3-256","ARRAYBUFFER");a.update(b);return m.from(a.getHash("ARRAYBUFFER"))}function w(b,a,c,e,d,x,h){var g=this;null==h&&(h=2);if(!(this instanceof w))return new w(b,a,c,e,d,x,h);if(d<B)throw Error("Minimal supported packet size is "+
B);D.call(this);1>x&&(x=1);this.m=new Map;var k=["psr:"+d+":"+x];e=this.b=M({extensions:k,simple_peer_constructor:t,simple_peer_opts:{config:{iceServers:e},packet_size:d,packets_per_second:x,sign:function(d){return f.sign(d,b,a)}}});e.on("websocket_peer_connection_alias",function(b,d,a){c.forEach(function(e){if(e.host===b&&e.port===d)return g.m.set(a,e.node_id),a.on("close",function(){g.m["delete"](a)})})});e.on("node_connected",function(b){var d=F(b);var a=g.b.get_id_mapping(b);if(g.m.has(a)){var e=
g.m.get(a);g.m["delete"](a);if(e!==b){a.destroy();return}}f.verify(a.J,a.G,d)?(a.on("routing_data",function(a,e){switch(a){case H:g.b.add_tag(b,"detox-responder");g.fire("node_tagged",d);break;case I:g.b.del_tag(b,"detox-responder");g.fire("node_untagged",d);break;case J:g.fire("data",d,e)}}),g.fire("node_connected",d)):a.destroy()});e.on("node_disconnected",function(b){g.fire("node_disconnected",F(b))});h=this.g=new N({bootstrap:c,extensions:k,hash:A,k:h,nodeId:m.from(b),socket:this.b,timeout:1E3*
O,verify:f.verify});h.on("error",function(b){g.fire("error",b)});h.once("ready",function(){g.fire("ready")})}function y(b,a,c){var e=this;null==c&&(c=10);if(!(this instanceof y))return new y(b,a,c);if(a<B)throw Error("Minimal supported packet size is "+B);D.call(this);this.h=new Map;this.l=new Map;this.j=new Map;this.i=new Map;this.c=new Map;this.w=new Map;this.a=u(P,a-3,z,Q,c).on("create_request",function(a){var d=a.address;var h=a.segment_id;var g=a.command_data;a=p(d,h);if(!e.h.has(a)){var c=f.Encryptor(!1,
b);try{c.put_handshake_message(g)}catch(q){return}e.a.create_response(d,h,c.get_handshake_message());e.a.confirm_incoming_segment_established(d,h);e.i.set(a,r.Multiplexer(C,e.s));e.c.set(a,r.Demultiplexer(C,e.s));if(c.ready()){h=c.get_rewrapper_keys().map(f.Rewrapper);g=d.join(",");var l=Object.create(null);l[g]=c;c=Object.create(null);c[g]=h;e.h.set(a,l);e.l.set(a,c);e.j.set(a,d)}}}).on("send",function(a){e.fire("send",a.address,a.packet)}).on("data",function(a){var b=a.address;var d=a.segment_id;
var c=a.target_address;a=a.command_data;var k=p(b,d);var l=e.j.get(k);c.join(",")===l.join(",")&&(c=e.c.get(k))&&(c.feed(a),c.have_more_data()&&(a=c.get_data(),e.fire("data",b,d,a)))}).on("destroy",function(a){var b=a.address;a=a.segment_id;e.o(b,a);e.fire("destroyed",b,a)}).on("encrypt",function(a){var b;var d=a.address;var c=a.segment_id;var k=a.target_address;var l=a.plaintext;d=p(d,c);k=k.join(",");(k=null!=(b=e.h.get(d))?b[k]:void 0)&&(a.ciphertext=k.encrypt(l))}).on("decrypt",function(a){var b;
var d=a.address;var c=a.segment_id;var l=a.target_address;var f=a.ciphertext;d=p(d,c);l=l.join(",");if(l=null!=(b=e.h.get(d))?b[l]:void 0)try{a.plaintext=l.decrypt(f)}catch(q){}}).on("wrap",function(a){var b,d;var c=a.address;var l=a.segment_id;var f=a.target_address;var q=a.unwrapped;c=p(c,l);f=f.join(",");(f=null!=(b=e.l.get(c))?null!=(d=b[f])?d[0]:void 0:void 0)&&(a.wrapped=f.wrap(q))}).on("unwrap",function(a){var b,c;var d=a.address;var l=a.segment_id;var f=a.target_address;var q=a.wrapped;d=
p(d,l);f=f.join(",");(f=null!=(b=e.l.get(d))?null!=(c=b[f])?c[1]:void 0:void 0)&&(a.unwrapped=f.unwrap(q))});this.s=this.a.get_max_command_data_length()}var R=c.bencode;var v=c["simple-peer"];var M=c["webrtc-socket"];var N=c["webtorrent-dht"];var m=c.Buffer;t.prototype=Object.create(v.prototype);c=t.prototype;c.emit=function(b,a){switch(b){case "signal":a.signature=m.from(this.I(G(a.sdp)));v.prototype.emit.call(this,"signal",a);break;case "data":if(this.u)this.destroy();else if(a.length!==this.f)this.destroy();
else{for(this.c.feed(a);this.c.have_more_data();){var c=this.c.get_data();var e=c[0];e===K?v.prototype.emit.call(this,"data",m.from(c.subarray(1))):v.prototype.emit.call(this,"routing_data",e,c.subarray(1))}this.u=!0;this.D()}break;default:v.prototype.emit.apply(this,arguments)}};c.signal=function(b){var a,c;if(b.signature&&b.extensions){this.J=b.signature;this.G=G(b.sdp);var e=!1;var d=0;for(c=(a=b.extensions).length;d<c;++d){var f=a[d];if(f.startsWith("psr:")){d=f.split(":");e=parseInt(d[1],10);
d=parseInt(d[2],10);if(e<B||1>d){this.destroy();return}this.f=Math.min(this.f,e);this.A=Math.min(this.A,d);e=!0;break}}e?v.prototype.signal.call(this,b):this.destroy()}else this.destroy()};c.send=function(b){this.F(b,K)};c.B=function(b,a){this.F(b,a)};c.F=function(b,a){var c;var e=c=new Uint8Array(b.length+1);e.set([a]);e.set(b,1);this.i.feed(c)};c.D=function(){var b=this;setTimeout(function(){b.destroyed||(v.prototype.send.call(b,b.i.get_block()),b.u=!1,b.C=+new Date)},Math.max(0,this.H-(new Date-
this.C)))};Object.defineProperty(t.prototype,"constructor",{enumerable:!1,value:t});w.prototype=Object.create(D.prototype);c=w.prototype;c.start_bootstrap_node=function(b,a){this.g.listen(a,b)};c.get_bootstrap_nodes=function(){var b,a,c=[];for(b in a=this.g._rpc.socket.socket._peer_connections){var e=a[b];e.ws_server&&e.id&&c.push({node_id:e.id,host:e.ws_server.host,port:e.ws_server.port})}return c.filter(Boolean)};c.lookup=function(b){this.g.lookup(m.from(b))};c.add_used_tag=function(b){var a;b=
E(b);if(a=this.b.get_id_mapping(b))a.B(new Uint8Array(0),H),this.b.add_tag(b,"detox-initiator")};c.del_used_tag=function(b){var a;b=E(b);if(a=this.b.get_id_mapping(b))a.B(new Uint8Array(0),I),this.b.del_tag(b,"detox-initiator")};c.send_data=function(b,a){a.length>this.f||(b=this.b.get_id_mapping(E(b)))&&b.B(a,J)};c.generate_introduction_message=function(b,a,c){var e;var d=+new Date;var l=new Uint8Array(c.length*z);var h=0;for(e=c.length;h<e;++h){var g=h;var k=c[h];l.set(k,g*z)}c=R.encode({seq:d,v:m.from(l)}).slice(1,
-1);a=f.sign(c,b,a);return{k:b,seq:d,sig:a,v:l}};c.publish_introduction_message=function(b){b.k&&b.seq&&b.sig&&b.v&&this.g.put({k:m.from(b.k),seq:parseInt(b.seq,10),sig:m.from(b.sig),v:m.from(b.v)})};c.find_introduction_nodes=function(b,a,c){b=A(b);this.g.get(b,function(b,d){var e;if(d&&d.v){if(b=Uint8Array.from(d.v),d=[],0===b.length%z){var f=0;for(e=b.length/z;f<e;++f){var g=f;d.push(b.subarray(g*z,(g+1)*z))}a(d)}}else c()})};c.destroy=function(b){this.g.destroy(b);delete this.g};Object.defineProperty(w.prototype,
"constructor",{enumerable:!1,value:w});y.prototype=Object.create(D.prototype);c=y.prototype;c.process_packet=function(b,a){this.a.process_packet(b,a)};c.construct_routing_path=function(b){var a=this;b=b.slice();return new Promise(function(c){function e(d){function l(){function d(b){var c=b.address;var e=b.segment_id;b=b.command_data;if(g===c.join(",")&&v===e.join(",")){a.a.off("extend_response",d);clearTimeout(w);b.length||q();try{k[p].put_handshake_message(b)}catch(T){q()}k[p].ready()||q();n[p]=
k[p].get_rewrapper_keys().map(f.Rewrapper);a.a.confirm_extended_path(h,m);l()}}var e;b.length?(a.a.on("extend_response",d),x=b.shift(),p=x.join(","),(e=f.convert_public_key(x))||q(),k[p]=f.Encryptor(!0,e),w=setTimeout(function(){a.a.off("extend_response",d);q()},1E3*L),a.a.extend_request(h,m,x,k[p].get_handshake_message())):(a.w.set(t,[h,m]),c(m))}var x,p,w;var y=d.address;var z=d.segment_id;d=d.command_data;if(g===y.join(",")&&v===z.join(",")){clearTimeout(u);a.a.off("create_response",e);try{k[g].put_handshake_message(d)}catch(S){q()}k[g].ready()||
q();n[g]=k[g].get_rewrapper_keys().map(f.Rewrapper);a.a.confirm_outgoing_segment_established(h,m);a.i.set(t,r.Multiplexer(C,a.s));a.c.set(t,r.Demultiplexer(C,a.s));l()}}var d;var l=b[b.length-1];var h=b.shift();var g=h.join(",");var k=Object.create(null);var n=Object.create(null);var q=function(){a.o(h,m);throw Error("Routing path creation failed");};(d=f.convert_public_key(h))||q();k[g]=f.Encryptor(!0,d);a.a.on("create_response",e);var u=setTimeout(function(){a.a.off("create_response",e);q()},1E3*
L);var m=a.a.create_request(h,k[g].get_handshake_message());var v=m.join(",");var t=p(h,m);a.h.set(t,k);a.l.set(t,n);a.j.set(t,l)})};c.destroy_routing_path=function(b,a){this.o(b,a)};c.send_data=function(b,a,c){if(!(c.length>C)){var e=p(b,a);var d=this.j.get(e);if(e=this.i.get(e))for(e.feed(c);e.have_more_blocks();)c=e.get_block(),this.a.data(b,a,d,c)}};c.destroy=function(){var b=this;this.w.forEach(function(a){b.o(a[0],a[1])})};c.o=function(b,a){function c(){var g,k;if(h){--h;try{d.a.destroy(b,a),
d.a.once("send",function(){c()})}catch(q){c()}}else{for(g in k=e){var l=k[g];l.destroy()}d.h["delete"](f);d.l["delete"](f);d.j["delete"](f);d.i["delete"](f);d.c["delete"](f);d.w["delete"](f)}}var e,d=this;var f=p(b,a);if(e=this.h.get(f)){var h=Object.keys(e).length;c()}};Object.defineProperty(y.prototype,"constructor",{enumerable:!1,value:y});return{ready:f.ready,DHT:w,Router:y}}var K=0;var J=1;var H=2;var I=3;var P=0;var z=32;var Q=16;var B=256;var L=10;var C=Math.pow(2,24)-1;var O=30;"function"===
typeof define&&define.amd?define("@detox/crypto @detox/dht ronion jssha/src/sha3 fixed-size-multiplexer async-eventer".split(" "),A):"object"===typeof exports?module.exports=A(require("@detox/crypto"),require("@detox/dht"),require("ronion"),require("jssha/src/sha3"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_transport=A(this.detox_crypto,this.detox_dht,this.ronion,this.jsSHA,this.fixed_size_multiplexer,this.async_eventer)}).call(this);