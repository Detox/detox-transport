/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(){function E(g){var e;var u="";var n=0;for(e=g.length;n<e;++n){var r=g[n];u+=r.toString(16).padStart(2,"0")}return u}function F(g){var e;var u=new Uint8Array(g.length/2);var n=0;for(e=u.length;n<e;++n){var r=n;u[r]=parseInt(g.substring(2*r,2*r+2),16)}return u}function G(g){var e;var u=new Uint8Array(g.length);var n=0;for(e=g.length;n<e;++n){var r=n;u[r]=g.charCodeAt(r)}return u}function p(g,e){return g.join(",")+e.join(",")}function A(g,e,u,n,r,D){function t(a){var b=this;if(!(this instanceof
t))return new t(a);this.I=a.sign;this.f=a.packet_size;this.A=a.packets_per_second;this.u=a.initiator;this.once("connect",function(){b.H=1E3/b.A;b.i=r.Multiplexer(b.f,b.f);b.c=r.Demultiplexer(b.f,b.f);b.C=+new Date;b.u&&b.D()});v.call(this,a)}function A(a){var b=new n("SHA3-256","ARRAYBUFFER");b.update(a);return m.from(b.getHash("ARRAYBUFFER"))}function w(a,b,f,d,c,x,k){var h=this;null==k&&(k=2);if(!(this instanceof w))return new w(a,b,f,d,c,x,k);if(c<B)throw Error("Minimal supported packet size is "+
B);D.call(this);1>x&&(x=1);this.m=new Map;var l=["psr:"+c+":"+x];d=this.b=M({extensions:l,simple_peer_constructor:t,simple_peer_opts:{config:{iceServers:d},packet_size:c,packets_per_second:x,sign:function(c){return g.sign(c,a,b)}}});d.on("websocket_peer_connection_alias",function(a,c,b){f.forEach(function(d){if(d.host===a&&d.port===c)return h.m.set(b,d.node_id),b.on("close",function(){h.m["delete"](b)})})});d.on("node_connected",function(a){var b=F(a);var c=h.b.get_id_mapping(a);if(h.m.has(c)){var d=
h.m.get(c);h.m["delete"](c);if(d!==a){c.destroy();return}}g.verify(c.J,c.G,b)?(c.on("routing_data",function(c,d){switch(c){case H:h.b.add_tag(a,"detox-responder");h.fire("node_tagged",b);break;case I:h.b.del_tag(a,"detox-responder");h.fire("node_untagged",b);break;case J:h.fire("data",b,d)}}),h.fire("node_connected",b)):c.destroy()});d.on("node_disconnected",function(a){h.fire("node_disconnected",F(a))});k=this.g=new N({bootstrap:f,extensions:l,hash:A,k:k,nodeId:m.from(a),socket:this.b,timeout:1E3*
O,verify:g.verify});k.on("error",function(a){h.fire("error",a)});k.once("ready",function(){h.fire("ready")})}function y(a,b,f){var d=this;null==f&&(f=10);if(!(this instanceof y))return new y(a,b,f);if(b<B)throw Error("Minimal supported packet size is "+B);D.call(this);this.h=new Map;this.l=new Map;this.j=new Map;this.i=new Map;this.c=new Map;this.w=new Map;this.a=u(P,b-3,z,Q,f).on("create_request",function(c){var b=c.address;var k=c.segment_id;var h=c.command_data;c=p(b,k);if(!d.h.has(c)){var l=g.Encryptor(!1,
a);try{l.put_handshake_message(h)}catch(q){return}d.a.create_response(b,k,l.get_handshake_message());d.a.confirm_incoming_segment_established(b,k);d.i.set(c,r.Multiplexer(C,d.s));d.c.set(c,r.Demultiplexer(C,d.s));if(l.ready()){k=l.get_rewrapper_keys().map(g.Rewrapper);h=b.join(",");var f=Object.create(null);f[h]=l;l=Object.create(null);l[h]=k;d.h.set(c,f);d.l.set(c,l);d.j.set(c,b)}}}).on("send",function(a){d.fire("send",{node_id:a.address,packet:a.packet})}).on("data",function(a){var b=a.address;
var c=a.segment_id;var h=a.target_address;a=a.command_data;var l=p(b,c);var f=d.j.get(l);h.join(",")===f.join(",")&&(h=d.c.get(l))&&(h.feed(a),h.have_more_data()&&(a=h.get_data(),d.fire("data",{node_id:b,route_id:c,data:a})))}).on("destroy",function(a){var b=a.address;a=a.segment_id;d.o(b,a);d.fire("destroyed",{node_id:b,route_id:a})}).on("encrypt",function(a){var b;var c=a.address;var h=a.segment_id;var f=a.target_address;var e=a.plaintext;c=p(c,h);f=f.join(",");(f=null!=(b=d.h.get(c))?b[f]:void 0)&&
(a.ciphertext=f.encrypt(e))}).on("decrypt",function(a){var b;var c=a.address;var f=a.segment_id;var e=a.target_address;var g=a.ciphertext;c=p(c,f);e=e.join(",");if(e=null!=(b=d.h.get(c))?b[e]:void 0)try{a.plaintext=e.decrypt(g)}catch(q){}}).on("wrap",function(a){var b,c;var f=a.address;var e=a.segment_id;var g=a.target_address;var q=a.unwrapped;f=p(f,e);g=g.join(",");(g=null!=(b=d.l.get(f))?null!=(c=b[g])?c[0]:void 0:void 0)&&(a.wrapped=g.wrap(q))}).on("unwrap",function(a){var b,c;var f=a.address;
var e=a.segment_id;var g=a.target_address;var q=a.wrapped;f=p(f,e);g=g.join(",");(g=null!=(b=d.l.get(f))?null!=(c=b[g])?c[1]:void 0:void 0)&&(a.unwrapped=g.unwrap(q))});this.s=this.a.get_max_command_data_length()}var R=e.bencode;var v=e["simple-peer"];var M=e["webrtc-socket"];var N=e["webtorrent-dht"];var m=e.Buffer;t.prototype=Object.create(v.prototype);e=t.prototype;e.emit=function(a,b){switch(a){case "signal":b.signature=m.from(this.I(G(b.sdp)));v.prototype.emit.call(this,"signal",b);break;case "data":if(this.u)this.destroy();
else if(b.length!==this.f)this.destroy();else{for(this.c.feed(b);this.c.have_more_data();){var f=this.c.get_data();var d=f[0];d===K?v.prototype.emit.call(this,"data",m.from(f.subarray(1))):v.prototype.emit.call(this,"routing_data",d,f.subarray(1))}this.u=!0;this.D()}break;default:v.prototype.emit.apply(this,arguments)}};e.signal=function(a){var b,f;if(a.signature&&a.extensions){this.J=a.signature;this.G=G(a.sdp);var d=!1;var c=0;for(f=(b=a.extensions).length;c<f;++c){var e=b[c];if(e.startsWith("psr:")){c=
e.split(":");d=parseInt(c[1],10);c=parseInt(c[2],10);if(d<B||1>c){this.destroy();return}this.f=Math.min(this.f,d);this.A=Math.min(this.A,c);d=!0;break}}d?v.prototype.signal.call(this,a):this.destroy()}else this.destroy()};e.send=function(a){this.F(a,K)};e.B=function(a,b){this.F(a,b)};e.F=function(a,b){var f;var d=f=new Uint8Array(a.length+1);d.set([b]);d.set(a,1);this.i.feed(f)};e.D=function(){var a=this;setTimeout(function(){a.destroyed||(v.prototype.send.call(a,a.i.get_block()),a.u=!1,a.C=+new Date)},
Math.max(0,this.H-(new Date-this.C)))};Object.defineProperty(t.prototype,"constructor",{enumerable:!1,value:t});w.prototype=Object.create(D.prototype);e=w.prototype;e.start_bootstrap_node=function(a,b){this.g.listen(b,a)};e.get_bootstrap_nodes=function(){var a,b,f=[];for(a in b=this.g._rpc.socket.socket._peer_connections){var d=b[a];d.ws_server&&d.id&&f.push({node_id:d.id,host:d.ws_server.host,port:d.ws_server.port})}return f.filter(Boolean)};e.lookup=function(a){this.g.lookup(m.from(a))};e.add_used_tag=
function(a){var b;a=E(a);if(b=this.b.get_id_mapping(a))b.B(new Uint8Array(0),H),this.b.add_tag(a,"detox-initiator")};e.del_used_tag=function(a){var b;a=E(a);if(b=this.b.get_id_mapping(a))b.B(new Uint8Array(0),I),this.b.del_tag(a,"detox-initiator")};e.send_data=function(a,b){b.length>this.f||(a=this.b.get_id_mapping(E(a)))&&a.B(b,J)};e.generate_introduction_message=function(a,b,f){var d;var c=+new Date;var e=new Uint8Array(f.length*z);var k=0;for(d=f.length;k<d;++k){var h=k;var l=f[k];e.set(l,h*z)}f=
R.encode({seq:c,v:m.from(e)}).slice(1,-1);b=g.sign(f,a,b);return{k:a,seq:c,sig:b,v:e}};e.publish_introduction_message=function(a){a.k&&a.seq&&a.sig&&a.v&&this.g.put({k:m.from(a.k),seq:parseInt(a.seq,10),sig:m.from(a.sig),v:m.from(a.v)})};e.find_introduction_nodes=function(a,b){a=A(a);this.g.get(a,function(a,d){var c;if(d&&d.v&&(a=Uint8Array.from(d.v),d=[],0===a.length%z)){var e=0;for(c=a.length/z;e<c;++e){var f=e;d.push(a.subarray(f*z,(f+1)*z))}b(d)}})};e.destroy=function(a){this.g.destroy(a);delete this.g};
Object.defineProperty(w.prototype,"constructor",{enumerable:!1,value:w});y.prototype=Object.create(D.prototype);e=y.prototype;e.process_packet=function(a,b){this.a.process_packet(a,b)};e.construct_routing_path=function(a){var b=this;a=a.slice();return new Promise(function(e){function d(c){function f(){function c(a){var d=a.address;var e=a.segment_id;a=a.command_data;if(h===d.join(",")&&v===e.join(",")){b.a.off("extend_response",c);clearTimeout(w);a.length||q();try{l[p].put_handshake_message(a)}catch(T){q()}l[p].ready()||
q();n[p]=l[p].get_rewrapper_keys().map(g.Rewrapper);b.a.confirm_extended_path(k,m);f()}}var d;a.length?(b.a.on("extend_response",c),x=a.shift(),p=x.join(","),(d=g.convert_public_key(x))||q(),l[p]=g.Encryptor(!0,d),w=setTimeout(function(){b.a.off("extend_response",c);q()},1E3*L),b.a.extend_request(k,m,x,l[p].get_handshake_message())):(b.w.set(t,[k,m]),e(m))}var x,p,w;var y=c.address;var z=c.segment_id;c=c.command_data;if(h===y.join(",")&&v===z.join(",")){clearTimeout(u);b.a.off("create_response",d);
try{l[h].put_handshake_message(c)}catch(S){q()}l[h].ready()||q();n[h]=l[h].get_rewrapper_keys().map(g.Rewrapper);b.a.confirm_outgoing_segment_established(k,m);b.i.set(t,r.Multiplexer(C,b.s));b.c.set(t,r.Demultiplexer(C,b.s));f()}}var c;var f=a[a.length-1];var k=a.shift();var h=k.join(",");var l=Object.create(null);var n=Object.create(null);var q=function(){b.o(k,m);throw Error("Routing path creation failed");};(c=g.convert_public_key(k))||q();l[h]=g.Encryptor(!0,c);b.a.on("create_response",d);var u=
setTimeout(function(){b.a.off("create_response",d);q()},1E3*L);var m=b.a.create_request(k,l[h].get_handshake_message());var v=m.join(",");var t=p(k,m);b.h.set(t,l);b.l.set(t,n);b.j.set(t,f)})};e.destroy_routing_path=function(a,b){this.o(a,b)};e.send_data=function(a,b,e){if(!(e.length>C)){var d=p(a,b);var c=this.j.get(d);if(d=this.i.get(d))for(d.feed(e);d.have_more_blocks();)e=d.get_block(),this.a.data(a,b,c,e)}};e.destroy=function(){var a=this;this.w.forEach(function(b){a.o(b[0],b[1])})};e.o=function(a,
b){function e(){var f,l;if(k){--k;try{c.a.destroy(a,b),c.a.once("send",function(){e()})}catch(q){e()}}else{for(f in l=d){var m=l[f];m.destroy()}c.h["delete"](g);c.l["delete"](g);c.j["delete"](g);c.i["delete"](g);c.c["delete"](g);c.w["delete"](g)}}var d,c=this;var g=p(a,b);if(d=this.h.get(g)){var k=Object.keys(d).length;e()}};Object.defineProperty(y.prototype,"constructor",{enumerable:!1,value:y});return{ready:g.ready,DHT:w,Router:y}}var K=0;var J=1;var H=2;var I=3;var P=0;var z=32;var Q=16;var B=
256;var L=10;var C=Math.pow(2,24)-1;var O=30;"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht ronion jssha/src/sha3 fixed-size-multiplexer async-eventer".split(" "),A):"object"===typeof exports?module.exports=A(require("@detox/crypto"),require("@detox/dht"),require("ronion"),require("jssha/src/sha3"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_transport=A(this.detox_crypto,this.detox_dht,this.ronion,this.jsSHA,this.fixed_size_multiplexer,this.async_eventer)}).call(this);