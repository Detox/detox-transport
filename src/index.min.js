/*
 0BSD
*/
(function(){function I(g,d){g[0]=g[1];g[1]=g[2];g[2]=g[3];g[3]=g[4];g[4]=d}function B(g,d,z,B,R,A,E,J){function r(a){var b=this;if(!(this instanceof r))return new r(a);this.L=a.sign;this.K=1E3/a.packets_per_second;this.s=a.initiator;this.D=A.Multiplexer(v,F);this.u=A.Demultiplexer(v,F);this.I=[new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0)];this.G=[new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0)];this.once("connect",
function(){b.C=+new Date;b.s&&b.F()});t.call(this,a)}function K(a){var b=new R("SHA3-256","ARRAYBUFFER");b.update(a);return l.from(b.getHash("ARRAYBUFFER"))}function w(a,b,e,c,p,k){var h=this;null==k&&(k=2);if(!(this instanceof w))return new w(a,b,e,c,p,k);E.call(this);1>p&&(p=1);this.l=new Map;c=this.c=S({simple_peer_constructor:r,simple_peer_opts:{config:{iceServers:c},packets_per_second:p,sign:function(c){return g.sign(c,a,b)}}});c.on("websocket_peer_connection_alias",function(a,b,c){e.forEach(function(e){if(e.host===
a&&e.port===b)return h.l.set(c,e.node_id),c.on("close",function(){h.l["delete"](c)})})});c.on("node_connected",function(a){var b=L(a);var c=h.c.get_id_mapping(a);if(h.l.has(c)){var e=h.l.get(c);h.l["delete"](c);if(e!==a){c.destroy();return}}g.verify(c.M,c.J,b)?(c.on("custom_data",function(c,e){switch(c){case M:h.c.add_tag(a,"detox-responder");h.fire("node_tagged",b);break;case N:h.c.del_tag(a,"detox-responder");h.fire("node_untagged",b);break;default:c<G||h.fire("data",b,c-G,e)}}),h.fire("node_connected",
b)):c.destroy()});c.on("node_disconnected",function(a){h.fire("node_disconnected",L(a))});k=this.f=new T({bootstrap:e,hash:K,k:k,nodeId:l.from(a),socket:this.c,timeout:1E3*U,verify:g.verify});k.on("error",function(a){h.fire("error",a)});k.once("ready",function(){h.fire("ready")})}function q(a,b){var e=this;null==b&&(b=10);if(!(this instanceof q))return new q(a,b);E.call(this);this.g=n();this.j=n();this.h=n();this.o=n();this.m=n();this.A=n();this.b=B(V,u,W,b).on("activity",function(a,b){e.fire("activity",
a,b)}).on("create_request",function(b,p,k){if(!e.a){var c=m([b,p]);if(!e.g.has(c)){var f=g.Encryptor(!1,a);try{f.put_handshake_message(k)}catch(X){return}e.b.create_response(b,p,f.get_handshake_message());e.b.confirm_incoming_segment_established(b,p);e.o.set(c,A.Multiplexer(v,e.i));e.m.set(c,A.Demultiplexer(v,e.i));f.ready()&&(p=f.get_rewrapper_keys().map(g.Rewrapper),k=n(),k.set(b,f),f=n(),f.set(b,p),e.g.set(c,k),e.j.set(c,f),e.h.set(c,b))}}}).on("send",function(a,b){e.fire("send",a,b)}).on("data",
function(a,b,k,h,f){if(!e.a){var c=m([a,b]);var p=e.h.get(c);C(k,p)&&(k=e.m.get(c))&&(k.feed(f),k.have_more_data()&&(f=k.get_data(),e.fire("data",a,b,h,f)))}}).on("encrypt",function(a){var b;if(!e.a){var c=a.address;var h=a.segment_id;var f=a.target_address;var d=a.plaintext;c=m([c,h]);(f=null!=(b=e.g.get(c))?b.get(f):void 0)&&f.ready()&&(a.ciphertext=f.encrypt(d))}}).on("decrypt",function(a){var b;if(!e.a){var c=a.address;var h=a.segment_id;var f=a.target_address;var d=a.ciphertext;c=m([c,h]);if((f=
null!=(b=e.g.get(c))?b.get(f):void 0)&&f.ready())try{a.plaintext=f.decrypt(d)}catch(Y){}}}).on("wrap",function(a){var b,c;if(!e.a){var d=a.address;var f=a.segment_id;var g=a.target_address;var l=a.unwrapped;d=m([d,f]);(g=null!=(b=e.j.get(d))?null!=(c=b.get(g))?c[0]:void 0:void 0)&&(a.wrapped=g.wrap(l))}}).on("unwrap",function(a){var b,c;if(!e.a){var d=a.address;var f=a.segment_id;var g=a.target_address;var l=a.wrapped;d=m([d,f]);(g=null!=(b=e.j.get(d))?null!=(c=b.get(g))?c[1]:void 0:void 0)&&(a.unwrapped=
g.unwrap(l))}});this.i=this.b.get_max_command_data_length()}var D=d.bencode;var t=d["simple-peer"];var S=d["webrtc-socket"];var T=d["webtorrent-dht"];var l=d.Buffer;var H=z.array2hex;var L=z.hex2array;var O=z.string2array;var C=z.are_arrays_equal;var m=z.concat_arrays;var n=z.ArrayMap;r.prototype=Object.create(t.prototype);d=r.prototype;d.emit=function(a,b){switch(a){case "signal":b.signature=l.from(this.L(O(b.sdp)));t.prototype.emit.call(this,"signal",b);break;case "data":if(this.s)this.destroy();
else if(b.length!==F)this.destroy();else{for(this.u.feed(b);this.u.have_more_data();){var e=this.u.get_data();var c=e[0];c===P?t.prototype.emit.call(this,"data",l.from(this.O(e.subarray(1)))):t.prototype.emit.call(this,"custom_data",c,e.subarray(1))}this.s=!0;this.F()}break;default:t.prototype.emit.apply(this,arguments)}};d.signal=function(a){if(a.signature){this.M=a.signature;this.J=O(a.sdp);try{t.prototype.signal.call(this,a)}catch(b){}}else this.destroy()};d.send=function(a){this.H(this.N(a),P)};
d.B=function(a,b){this.H(a,b)};d.H=function(a,b){var e;var c=e=new Uint8Array(a.length+1);c.set([b]);c.set(a,1);this.D.feed(e)};d.F=function(){var a=this;setTimeout(function(){a.destroyed||(t.prototype.send.call(a,a.D.get_block()),a.s=!1,a.C=+new Date)},Math.max(0,this.K-(new Date-this.C)))};d.N=function(a){var b=J.deflate(a,{dictionary:m(this.I),level:1});I(this.I,a);return b};d.O=function(a){a=J.inflate(a,{dictionary:m(this.G)});I(this.G,a);return a};Object.defineProperty(r.prototype,"constructor",
{enumerable:!1,value:r});w.prototype=Object.create(E.prototype);d=w.prototype;d.start_bootstrap_node=function(a,b){this.a||this.f.listen(b,a)};d.get_bootstrap_nodes=function(){if(this.a)var a=[];else{var b,e,c=[];for(b in e=this.f._rpc.socket.socket._peer_connections)a=e[b],a.ws_server&&a.id&&c.push({node_id:a.id,host:a.ws_server.host,port:a.ws_server.port});a=c.filter(Boolean)}return a};d.lookup=function(a){this.a||this.f.lookup(l.from(a))};d.add_used_tag=function(a){var b;!this.a&&(a=H(a),b=this.c.get_id_mapping(a))&&
(b.B(new Uint8Array(0),M),this.c.add_tag(a,"detox-initiator"))};d.del_used_tag=function(a){var b;!this.a&&(a=H(a),b=this.c.get_id_mapping(a))&&(b.B(new Uint8Array(0),N),this.c.del_tag(a,"detox-initiator"))};d.send_data=function(a,b,e){this.a||e.length>v||(a=H(a),(a=this.c.get_id_mapping(a))&&a.B(e,b+G))};d.generate_announcement_message=function(a,b,e){var c;var d=+new Date;var k=new Uint8Array(e.length*u);var h=0;for(c=e.length;h<c;++h){var f=h;var m=e[h];k.set(m,f*u)}e=D.encode({seq:d,v:l.from(k)}).slice(1,
-1);b=g.sign(e,a,b);return Uint8Array.from(D.encode({k:l.from(a),seq:d,sig:l.from(b),v:l.from(k)}))};d.verify_announcement_message=function(a){try{a=D.decode(l.from(a))}catch(e){}if(!(a&&a.k&&a.seq&&a.sig&&a.v))return null;var b=D.encode({seq:a.seq,v:a.v}).slice(1,-1);return g.verify(a.sig,b,a.k)?Uint8Array.from(a.k):null};d.publish_announcement_message=function(a){!this.a&&this.verify_announcement_message(a)&&this.f.put(D.decode(l.from(a)))};d.find_introduction_nodes=function(a,b,e){this.a||(a=K(a),
this.f.get(a,function(a,d){var c;if(d&&d.v){if(a=Uint8Array.from(d.v),d=[],0===a.length%u){var g=0;for(c=a.length/u;g<c;++g){var f=g;d.push(a.subarray(f*u,(f+1)*u))}b(d)}}else e()}))};d.destroy=function(a){this.a||(this.f.destroy(a),delete this.f,this.a=!0)};Object.defineProperty(w.prototype,"constructor",{enumerable:!1,value:w});q.prototype=Object.create(E.prototype);d=q.prototype;d.process_packet=function(a,b){this.a||this.b.process_packet(a,b)};d.construct_routing_path=function(a){var b=this;if(this.a)return Promise.reject();
a=a.slice();return new Promise(function(e,c){function d(c,h,k){function p(){function c(a,d,e){if(C(f,a)&&C(y,d))if(b.b.off("extend_response",c),clearTimeout(u),e.length){try{n.put_handshake_message(e)}catch(aa){x();return}n.ready()?(t.set(m,n.get_rewrapper_keys().map(g.Rewrapper)),b.b.confirm_extended_path(f,y),p()):x()}else x()}var d;a.length?(b.b.on("extend_response",c),m=a.shift(),(d=g.convert_public_key(m))?(n=g.Encryptor(!0,d),l.set(m,n),u=setTimeout(function(){b.b.off("extend_response",c);x()},
1E3*Q),b.b.extend_request(f,y,m,n.get_handshake_message())):x()):(b.A.set(q,[f,y]),e(y))}var m,n,u;if(C(f,c)&&C(y,h)){clearTimeout(w);b.b.off("create_response",d);try{r.put_handshake_message(k)}catch(Z){x();return}r.ready()?(t.set(f,r.get_rewrapper_keys().map(g.Rewrapper)),b.b.confirm_outgoing_segment_established(f,y),b.o.set(q,A.Multiplexer(v,b.i)),b.m.set(q,A.Demultiplexer(v,b.i)),p()):x()}}var k;var h=a[a.length-1];var f=a.shift();var l=n();var t=n();var x=function(){b.w(f,y);c("Routing path creation failed")};
if(k=g.convert_public_key(f)){var r=g.Encryptor(!0,k);l.set(f,r);b.b.on("create_response",d);var w=setTimeout(function(){b.b.off("create_response",d);x()},1E3*Q);var y=b.b.create_request(f,r.get_handshake_message());var q=m([f,y]);b.g.set(q,l);b.j.set(q,t);b.h.set(q,h)}else x()})};d.destroy_routing_path=function(a,b){this.w(a,b)};d.get_max_packet_data_size=function(){return this.i};d.send_data=function(a,b,e,c){if(!(this.a||c.length>v)){var d=m([a,b]);var g=this.h.get(d);if(d=this.o.get(d))for(d.feed(c);d.have_more_blocks();)c=
d.get_block(),this.b.data(a,b,g,e,c)}};d.destroy=function(){var a=this;this.a||(this.a=!0,this.A.forEach(function(b){a.w(b[0],b[1])}))};d.w=function(a,b){a=m([a,b]);if(b=this.g.get(a))b.forEach(function(a){a.destroy()}),this.g["delete"](a),this.j["delete"](a),this.h["delete"](a),this.o["delete"](a),this.m["delete"](a),this.A["delete"](a)};Object.defineProperty(q.prototype,"constructor",{enumerable:!1,value:q});return{ready:g.ready,DHT:w,Router:q,MAX_DATA_SIZE:v}}var P=0;var M=1;var N=2;var G=10;var u=
32;var W=16;var Q=10;var v=Math.pow(2,16)-1;var F=512;var V=F-3;var U=30;"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht @detox/utils ronion jssha/src/sha3 fixed-size-multiplexer async-eventer pako".split(" "),B):"object"===typeof exports?module.exports=B(require("@detox/crypto"),require("@detox/dht"),require("@detox/utils"),require("ronion"),require("jssha/src/sha3"),require("fixed-size-multiplexer"),require("async-eventer"),require("pako")):this.detox_transport=B(this.detox_crypto,
this.detox_dht,this.detox_utils,this.ronion,this.jsSHA,this.fixed_size_multiplexer,this.async_eventer,this.pako)}).call(this);