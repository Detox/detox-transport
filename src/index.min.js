/*
 0BSD
*/
(function(){function H(g,e){g[0]=g[1];g[1]=g[2];g[2]=g[3];g[3]=g[4];g[4]=e}function A(g,e,u,A,z,D,I,r){function t(a){var b=this;if(!(this instanceof t))return new t(a);this.N=a.sign;this.M=1E3/a.packets_per_second;this.s=a.initiator;this.F=z.Multiplexer(v,E);this.u=z.Demultiplexer(v,E);this.J=[new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0)];this.H=[new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0)];this.once("connect",
function(){b.D=+new Date;b.s&&b.G()});r.call(this,a)}function J(a){return a.constructor.from(g.sha3_256(a))}function q(a,b,d,c,n,h,m){var f=this;null==h&&(h=2);null==m&&(m={});if(!(this instanceof q))return new q(a,b,d,c,n,h,m);D.call(this);1>n&&(n=1);this.l=new Map;this.C={};c=this.c=Q({simple_peer_constructor:t,simple_peer_opts:{config:{iceServers:c},packets_per_second:n,sign:function(c){return g.sign(c,a,b)}},http_address:this.C});c.on("http_peer_connection_alias",function(a,b,c){d.forEach(function(d){if(d.host===
a&&d.port===b)return f.l.set(c,d.node_id),c.on("close",function(){f.l["delete"](c)})})});c.on("node_connected",function(a){var b=K(a);var c=f.c.get_id_mapping(a);if(f.l.has(c)){var d=f.l.get(c);f.l["delete"](c);if(d!==a){c.destroy();return}}g.verify(c.O,c.L,b)?(c.on("custom_data",function(c,d){if(!f.K)switch(c){case L:f.c.add_tag(a,"detox-responder");f.fire("node_tagged",b);break;case M:f.c.del_tag(a,"detox-responder");f.fire("node_untagged",b);break;default:c<F||f.fire("data",b,c-F,d)}}),f.fire("node_connected",
b)):c.destroy()});c.on("node_disconnected",function(a){f.fire("node_disconnected",K(a))});h=this.g=new R(Object.assign({bootstrap:d,hash:J,k:h,nodeId:a,socket:this.c,timeout:1E3*S,verify:g.verify},m));h.on("error",function(a){f.fire("error",a)});h.once("ready",function(){f.fire("ready")})}function y(a,b){var d=this;null==b&&(b=10);if(!(this instanceof y))return new y(a,b);D.call(this);this.f=k();this.j=k();this.h=k();this.o=k();this.m=k();this.A=k();this.b=A(T,p,U,b).on("activity",function(a,b){d.fire("activity",
a,b)}).on("create_request",function(b,n,h){if(!d.a){var c=l([b,n]);if(!d.f.has(c)){var f=g.Encryptor(!1,a);try{f.put_handshake_message(h)}catch(V){return}d.b.create_response(b,n,f.get_handshake_message());d.b.confirm_incoming_segment_established(b,n);d.o.set(c,z.Multiplexer(v,d.i));d.m.set(c,z.Demultiplexer(v,d.i));f.ready()&&(n=f.get_rewrapper_keys().map(g.Rewrapper),h=k(),h.set(b,f),f=k(),f.set(b,n),d.f.set(c,h),d.j.set(c,f),d.h.set(c,b))}}}).on("send",function(a,b){d.fire("send",a,b)}).on("data",
function(a,b,h,e,f){if(!d.a){var c=l([a,b]);var n=d.h.get(c);B(h,n)&&(h=d.m.get(c))&&(h.feed(f),h.have_more_data()&&(f=h.get_data(),d.fire("data",a,b,e,f)))}}).on("encrypt",function(a){var b;if(!d.a){var c=a.address;var e=a.segment_id;var f=a.target_address;var g=a.plaintext;c=l([c,e]);(f=null!=(b=d.f.get(c))?b.get(f):void 0)&&f.ready()&&(a.ciphertext=f.encrypt(g))}}).on("decrypt",function(a){var b;if(!d.a){var c=a.address;var e=a.segment_id;var f=a.target_address;var g=a.ciphertext;c=l([c,e]);if((e=
null!=(b=d.f.get(c))?b.get(f):void 0)&&e.ready())try{a.plaintext=e.decrypt(g)}catch(W){e.destroy(),d.f.get(c)["delete"](f)}}}).on("wrap",function(a){var b,c;if(!d.a){var e=a.address;var f=a.segment_id;var g=a.target_address;var k=a.unwrapped;e=l([e,f]);(g=null!=(b=d.j.get(e))?null!=(c=b.get(g))?c[0]:void 0:void 0)&&(a.wrapped=g.wrap(k))}}).on("unwrap",function(a){var b,c;if(!d.a){var e=a.address;var f=a.segment_id;var g=a.target_address;var k=a.wrapped;e=l([e,f]);(g=null!=(b=d.j.get(e))?null!=(c=
b.get(g))?c[1]:void 0:void 0)&&(a.unwrapped=g.unwrap(k))}});this.i=this.b.get_max_command_data_length()}var C=e.bencode;var Q=e["webrtc-socket"];var R=e["webtorrent-dht"];var G=u.array2hex;var K=u.hex2array;var N=u.string2array;var B=u.are_arrays_equal;var l=u.concat_arrays;var k=u.ArrayMap;t.prototype=Object.create(r.prototype);e=t.prototype;e.emit=function(a,b){switch(a){case "signal":b.signature=Array.from(this.N(N(b.sdp)));r.prototype.emit.call(this,"signal",b);break;case "data":if(this.s)this.destroy();
else if(b.length!==E)this.destroy();else{for(this.u.feed(b);this.u.have_more_data();){var d=this.u.get_data();var c=d[0];c===O?r.prototype.emit.call(this,"data",this.R(d.subarray(1))):r.prototype.emit.call(this,"custom_data",c,d.subarray(1))}this.s=!0;this.G()}break;default:r.prototype.emit.apply(this,arguments)}};e.signal=function(a){if(a.signature){this.O=Uint8Array.from(a.signature);this.L=N(a.sdp);try{r.prototype.signal.call(this,a)}catch(b){}}else this.destroy()};e.send=function(a){this.I(this.P(a),
O)};e.B=function(a,b){this.I(a,b)};e.I=function(a,b){var d;var c=d=new Uint8Array(a.length+1);c.set([b]);c.set(a,1);this.F.feed(d)};e.G=function(){var a=this;setTimeout(function(){a.destroyed||(r.prototype.send.call(a,a.F.get_block()),a.s=!1,a.D=+new Date)},Math.max(0,this.M-(new Date-this.D)))};e.P=function(a){var b=I.deflate(a,{dictionary:l(this.J),level:1});H(this.J,a);return b};e.R=function(a){a=I.inflate(a,{dictionary:l(this.H)});H(this.H,a);return a};e.setMaxListeners=function(){};Object.defineProperty(t.prototype,
"constructor",{value:t});q.prototype=Object.create(D.prototype);e=q.prototype;e.start_bootstrap_node=function(a,b,d,c){null==d&&(d=a);null==c&&(c=b);this.a||(Object.assign(this.C,{address:d,port:c}),this.g.listen(b,a),this.K=!0)};e.get_bootstrap_nodes=function(){if(this.a)var a=[];else{var b,d,c=[];for(b in d=this.g._rpc.socket.socket._peer_connections)a=d[b],a.http_server&&a.id&&c.push({node_id:a.id,host:a.http_server.host,port:a.http_server.port});a=c.filter(Boolean)}return a};e.lookup=function(a){this.a||
this.g.lookup(a)};e.add_used_tag=function(a){var b;!this.a&&(a=G(a),b=this.c.get_id_mapping(a))&&(b.B(new Uint8Array(0),L),this.c.add_tag(a,"detox-initiator"))};e.del_used_tag=function(a){var b;!this.a&&(a=G(a),b=this.c.get_id_mapping(a))&&(b.B(new Uint8Array(0),M),this.c.del_tag(a,"detox-initiator"))};e.send_data=function(a,b,d){this.a||d.length>v||(a=G(a),(a=this.c.get_id_mapping(a))&&a.B(d,b+F))};e.generate_announcement_message=function(a,b,d){var c;var e=+new Date;var h=new Uint8Array(d.length*
p);var m=0;for(c=d.length;m<c;++m){var f=m;var k=d[m];h.set(k,f*p)}d=C.encode({seq:e,v:h}).slice(1,-1);b=g.sign(d,a,b);return Uint8Array.from(C.encode({k:a,seq:e,sig:b,v:h}))};e.verify_announcement_message=function(a){try{a=C.decode(a)}catch(d){}if(!(a&&a.k&&a.seq&&a.sig&&a.v))return null;var b=C.encode({seq:a.seq,v:a.v}).slice(1,-1);return g.verify(a.sig,b,a.k)?Uint8Array.from(a.k):null};e.publish_announcement_message=function(a){!this.a&&this.verify_announcement_message(a)&&this.g.put(C.decode(a))};
e.find_introduction_nodes=function(a,b,d){this.a||(a=J(a),this.g.get(a,function(a,e){var c;if(e&&e.v){if(a=Uint8Array.from(e.v),e=[],0===a.length%p){var g=0;for(c=a.length/p;g<c;++g){var f=g;e.push(a.subarray(f*p,(f+1)*p))}b(e)}}else"function"==typeof d&&d()}))};e.destroy=function(a){this.a||(this.g.destroy(a),delete this.g,this.a=!0)};Object.defineProperty(q.prototype,"constructor",{value:q});y.prototype=Object.create(D.prototype);e=y.prototype;e.process_packet=function(a,b){this.a||this.b.process_packet(a,
b)};e.construct_routing_path=function(a){var b=this;if(this.a)return Promise.reject();a=a.slice();return new Promise(function(d,c){function e(c,h,n){function k(){function c(a,d,e){if(B(f,a)&&B(x,d))if(b.b.off("extend_response",c),clearTimeout(u),e.length){try{l.put_handshake_message(e)}catch(Y){w();return}l.ready()?(t.set(m,l.get_rewrapper_keys().map(g.Rewrapper)),b.b.confirm_extended_path(f,x),k()):w()}else w()}var e;a.length?(b.b.on("extend_response",c),m=a.shift(),(e=g.convert_public_key(m))?(l=
g.Encryptor(!0,e),r.set(m,l),u=setTimeout(function(){b.b.off("extend_response",c);w()},1E3*P),b.b.extend_request(f,x,m,l.get_handshake_message())):w()):(b.A.set(p,[f,x]),d(x))}var m,l,u;if(B(f,c)&&B(x,h)){clearTimeout(y);b.b.off("create_response",e);try{q.put_handshake_message(n)}catch(X){w();return}q.ready()?(t.set(f,q.get_rewrapper_keys().map(g.Rewrapper)),b.b.confirm_outgoing_segment_established(f,x),b.o.set(p,z.Multiplexer(v,b.i)),b.m.set(p,z.Demultiplexer(v,b.i)),k()):w()}}var h;var m=a[a.length-
1];var f=a.shift();var r=k();var t=k();var w=function(){b.w(f,x);c("Routing path creation failed")};if(h=g.convert_public_key(f)){var q=g.Encryptor(!0,h);r.set(f,q);b.b.on("create_response",e);var y=setTimeout(function(){b.b.off("create_response",e);w()},1E3*P);var x=b.b.create_request(f,q.get_handshake_message());var p=l([f,x]);b.f.set(p,r);b.j.set(p,t);b.h.set(p,m)}else w()})};e.destroy_routing_path=function(a,b){this.w(a,b)};e.get_max_packet_data_size=function(){return this.i};e.send_data=function(a,
b,e,c){if(!(this.a||c.length>v)){var d=l([a,b]);var g=this.h.get(d);if(d=this.o.get(d))for(d.feed(c);d.have_more_blocks();)c=d.get_block(),this.b.data(a,b,g,e,c)}};e.destroy=function(){var a=this;this.a||(this.a=!0,this.A.forEach(function(b){a.w(b[0],b[1])}))};e.w=function(a,b){a=l([a,b]);if(b=this.f.get(a))b.forEach(function(a){a.destroy()}),this.f["delete"](a),this.j["delete"](a),this.h["delete"](a),this.o["delete"](a),this.m["delete"](a),this.A["delete"](a)};Object.defineProperty(y.prototype,"constructor",
{value:y});return{ready:g.ready,DHT:q,Router:y,MAX_DATA_SIZE:v}}var O=0;var L=1;var M=2;var F=10;var p=32;var U=16;var P=10;var v=Math.pow(2,16)-1;var E=512;var T=E-3;var S=30;"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht @detox/utils ronion fixed-size-multiplexer async-eventer pako @detox/simple-peer".split(" "),A):"object"===typeof exports?module.exports=A(require("@detox/crypto"),require("@detox/dht"),require("@detox/utils"),require("ronion"),require("fixed-size-multiplexer"),
require("async-eventer"),require("pako"),require("@detox/simple-peer")):this.detox_transport=A(this.detox_crypto,this.detox_dht,this.detox_utils,this.ronion,this.fixed_size_multiplexer,this.async_eventer,this.pako,this.SimplePeer)}).call(this);