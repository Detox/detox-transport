/*
 0BSD
*/
(function(){function n(a,f){a[0]=a[1];a[1]=a[2];a[2]=a[3];a[3]=a[4];a[4]=f}function g(a,g,p,q,t,u){function e(b,h,a){var c=this;if(!(this instanceof e))return new e(b,h,a);p.call(this);this.o=b;this.a=t({config:{iceServers:h},initiator:b,trickle:!1,wrtc:u});this.l=new Promise(function(b,h){var a=c.a;a.once("signal",function(a){b(v(a.sdp))});a.once("close",h)});this.l["catch"](function(){});this.s=1E3/a;this.b=b;this.g=g.Multiplexer(f,l);this.c=g.Demultiplexer(f,l);this.j=[d,d,d,d,d];this.i=[d,d,d,
d,d];b=this.a;b.once("connect",function(){c.fire("connected");c.f=+new Date;c.b&&c.h()});b.once("close",function(){c.fire("disconnected")});b.on("data",function(b){if(c.b||b.length!==l)c.destroy();else{for(c.c.feed(b);c.c.have_more_data();){var a=c.c.get_data();b=a[0];a=a.subarray(1);b<r&&(a=c.w(a));c.fire("data",b,a)}c.b=!0;c.h()}})}var w=a.array2string;var v=a.string2array;var k=a.concat_arrays;var d=new Uint8Array(0);e.prototype={get_signaling:function(){return this.l},set_signaling:function(b){this.a.signal({type:this.o?
"answer":"offer",sdp:w(b)})},send:function(b,a){if(!(a.length>f)){if(b<r){if(a.length>m)return;a=this.v(a)}b=k([[b],a]);this.g.feed(b)}},destroy:function(){this.m=!0;clearTimeout(this.u);this.a.destroy()},h:function(){var b=this;this.u=setTimeout(function(){if(!b.m)try{b.a.send(b.g.get_block()),b.b=!1,b.f=+new Date}catch(h){}},Math.max(0,this.s-(new Date-this.f)))},v:function(b){var a=q.deflate(b,{dictionary:k(this.j),level:1});n(this.j,b);return a.length>m?k([[0],b]):k([[1],a])},w:function(b){var a;
var d=b[0];b=b.subarray(1);d?a=q.inflate(b,{dictionary:k(this.i)}):a=b;n(this.i,a);return a}};e.prototype=Object.assign(Object.create(p.prototype),e.prototype);Object.defineProperty(e.prototype,"constructor",{value:e});return{P2P_transport:e,MAX_DATA_SIZE:f,MAX_DHT_DATA_SIZE:m}}var r=10;var f=Math.pow(2,16)-2;var m=f-1;var l=512;"function"===typeof define&&define.amd?define(["@detox/utils","fixed-size-multiplexer","async-eventer","pako","@detox/simple-peer"],g):"object"===typeof exports?module.exports=
g(require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer"),require("pako"),require("@detox/simple-peer"),require("wrtc")):this.detox_transport=g(this.detox_utils,this.fixed_size_multiplexer,this.async_eventer,this.pako,this.SimplePeer)}).call(this);