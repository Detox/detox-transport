/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(){function D(g){var c;var m="";var n=0;for(c=g.length;n<c;++n){var q=g[n];m+=q.toString(16).padStart(2,"0")}return m}function G(g){var c;var m=new Uint8Array(g.length/2);var n=0;for(c=m.length;n<c;++n){var q=n;m[q]=parseInt(g.substring(2*q,2*q+2),16)}return m}function H(g){var c;var m=new Uint8Array(g.length);var n=0;for(c=g.length;n<c;++n){var q=n;m[q]=g.charCodeAt(q)}return m}function u(g,c){return g.join(",")+c.join(",")}function z(g,c,m,n,q,C){function x(a){var b=this;if(!(this instanceof
x))return new x(a);this.I=a.sign;this.i=a.packet_size;this.A=a.packets_per_second;this.s=a.initiator;this.once("connect",function(){b.H=1E3/b.A;b.h=q.Multiplexer(A,b.i);b.c=q.Demultiplexer(A,b.i);b.C=+new Date;b.s&&b.D()});p.call(this,a)}function z(a){var b=new n("SHA3-256","ARRAYBUFFER");b.update(a);return v.from(b.getHash("ARRAYBUFFER"))}function t(a,b,c,e,d,y,h){var k=this;null==h&&(h=2);if(!(this instanceof t))return new t(a,b,c,e,d,y,h);if(d<B)throw Error("Minimal supported packet size is "+
B);C.call(this);1>y&&(y=1);this.m=new Map;var f=["psr:"+d+":"+y];e=this.b=M({extensions:f,simple_peer_constructor:x,simple_peer_opts:{config:{iceServers:e},packet_size:d,packets_per_second:y,sign:function(d){return g.sign(d,a,b)}}});e.on("websocket_peer_connection_alias",function(a,b,d){c.forEach(function(e){if(e.host===a&&e.port===b)return k.m.set(d,e.node_id),d.on("close",function(){k.m["delete"](d)})})});e.on("node_connected",function(a){var b=G(a);var d=k.b.get_id_mapping(a);if(k.m.has(d)){var e=
k.m.get(d);k.m["delete"](d);if(e!==a){d.destroy();return}}g.verify(d.J,d.G,b)?(d.on("custom_data",function(d,e){switch(d){case I:k.b.add_tag(a,"detox-responder");k.fire("node_tagged",b);break;case J:k.b.del_tag(a,"detox-responder");k.fire("node_untagged",b);break;default:d<E||k.fire("data",b,d-E,e)}}),k.fire("node_connected",b)):d.destroy()});e.on("node_disconnected",function(a){k.fire("node_disconnected",G(a))});h=this.f=new O({bootstrap:c,extensions:f,hash:z,k:h,nodeId:v.from(a),socket:this.b,timeout:1E3*
P,verify:g.verify});h.on("error",function(a){k.fire("error",a)});h.once("ready",function(){k.fire("ready")})}function w(a,b,c){var e=this;null==c&&(c=10);if(!(this instanceof w))return new w(a,b,c);if(b<B)throw Error("Minimal supported packet size is "+B);C.call(this);this.g=new Map;this.l=new Map;this.j=new Map;this.h=new Map;this.c=new Map;this.w=new Map;this.a=m(Q,b-3,r,R,c).on("activity",function(a,b){e.fire("activity",a,b)}).on("create_request",function(b,c,h){var d=u(b,c);if(!e.g.has(d)){var f=
g.Encryptor(!1,a);try{f.put_handshake_message(h)}catch(N){return}e.a.create_response(b,c,f.get_handshake_message());e.a.confirm_incoming_segment_established(b,c);e.h.set(d,q.Multiplexer(A,e.o));e.c.set(d,q.Demultiplexer(A,e.o));if(f.ready()){c=f.get_rewrapper_keys().map(g.Rewrapper);h=b.join(",");var y=Object.create(null);y[h]=f;f=Object.create(null);f[h]=c;e.g.set(d,y);e.l.set(d,f);e.j.set(d,b)}}}).on("send",function(a,b){e.fire("send",a,b)}).on("data",function(a,b,c,k,f){var d=u(a,b);var h=e.j.get(d);
c.join(",")===h.join(",")&&(c=e.c.get(d))&&(c.feed(f),c.have_more_data()&&(f=c.get_data(),e.fire("data",a,b,k,f)))}).on("encrypt",function(a){var b;var d=a.address;var c=a.segment_id;var f=a.target_address;var l=a.plaintext;d=u(d,c);f=f.join(",");(f=null!=(b=e.g.get(d))?b[f]:void 0)&&(a.ciphertext=f.encrypt(l))}).on("decrypt",function(a){var b;var d=a.address;var c=a.segment_id;var f=a.target_address;var l=a.ciphertext;d=u(d,c);f=f.join(",");if(f=null!=(b=e.g.get(d))?b[f]:void 0)try{a.plaintext=f.decrypt(l)}catch(N){}}).on("wrap",
function(a){var b,d;var c=a.address;var f=a.segment_id;var l=a.target_address;var g=a.unwrapped;c=u(c,f);l=l.join(",");(l=null!=(b=e.l.get(c))?null!=(d=b[l])?d[0]:void 0:void 0)&&(a.wrapped=l.wrap(g))}).on("unwrap",function(a){var b,d;var c=a.address;var f=a.segment_id;var l=a.target_address;var g=a.wrapped;c=u(c,f);l=l.join(",");(l=null!=(b=e.l.get(c))?null!=(d=b[l])?d[1]:void 0:void 0)&&(a.unwrapped=l.unwrap(g))});this.o=this.a.get_max_command_data_length()}var F=c.bencode;var p=c["simple-peer"];
var M=c["webrtc-socket"];var O=c["webtorrent-dht"];var v=c.Buffer;x.prototype=Object.create(p.prototype);c=x.prototype;c.emit=function(a,b){switch(a){case "signal":b.signature=v.from(this.I(H(b.sdp)));p.prototype.emit.call(this,"signal",b);break;case "data":if(this.s)this.destroy();else if(b.length!==this.i)this.destroy();else{for(this.c.feed(b);this.c.have_more_data();){var c=this.c.get_data();var e=c[0];e===K?p.prototype.emit.call(this,"data",v.from(c.subarray(1))):p.prototype.emit.call(this,"custom_data",
e,c.subarray(1))}this.s=!0;this.D()}break;default:p.prototype.emit.apply(this,arguments)}};c.signal=function(a){var b,c;if(a.signature&&a.extensions){this.J=a.signature;this.G=H(a.sdp);var e=!1;var d=0;for(c=(b=a.extensions).length;d<c;++d){var g=b[d];if(g.startsWith("psr:")){d=g.split(":");e=parseInt(d[1],10);d=parseInt(d[2],10);if(e<B||1>d){this.destroy();return}this.i=Math.min(this.i,e);this.A=Math.min(this.A,d);e=!0;break}}e?p.prototype.signal.call(this,a):this.destroy()}else this.destroy()};
c.send=function(a){this.F(a,K)};c.B=function(a,b){this.F(a,b)};c.F=function(a,b){var c;var e=c=new Uint8Array(a.length+1);e.set([b]);e.set(a,1);this.h.feed(c)};c.D=function(){var a=this;setTimeout(function(){a.destroyed||(p.prototype.send.call(a,a.h.get_block()),a.s=!1,a.C=+new Date)},Math.max(0,this.H-(new Date-this.C)))};Object.defineProperty(x.prototype,"constructor",{enumerable:!1,value:x});t.prototype=Object.create(C.prototype);c=t.prototype;c.start_bootstrap_node=function(a,b){this.f.listen(b,
a)};c.get_bootstrap_nodes=function(){var a,b,c=[];for(a in b=this.f._rpc.socket.socket._peer_connections){var e=b[a];e.ws_server&&e.id&&c.push({node_id:e.id,host:e.ws_server.host,port:e.ws_server.port})}return c.filter(Boolean)};c.lookup=function(a){this.f.lookup(v.from(a))};c.add_used_tag=function(a){var b;a=D(a);if(b=this.b.get_id_mapping(a))b.B(new Uint8Array(0),I),this.b.add_tag(a,"detox-initiator")};c.del_used_tag=function(a){var b;a=D(a);if(b=this.b.get_id_mapping(a))b.B(new Uint8Array(0),J),
this.b.del_tag(a,"detox-initiator")};c.send_data=function(a,b,c){c.length>this.i||(a=this.b.get_id_mapping(D(a)))&&a.B(c,b+E)};c.generate_announcement_message=function(a,b,c){var e;var d=+new Date;var l=new Uint8Array(c.length*r);var h=0;for(e=c.length;h<e;++h){var k=h;var f=c[h];l.set(f,k*r)}c=F.encode({seq:d,v:v.from(l)}).slice(1,-1);b=g.sign(c,a,b);return Uint8Array.from(F.encode({k:v.from(a),seq:d,sig:v.from(b),v:v.from(l)}))};c.publish_announcement_message=function(a){try{a=F.decode(v.from(a))}catch(b){}a&&
a.k&&a.seq&&a.sig&&a.v&&this.f.put(a)};c.find_introduction_nodes=function(a,b,c){a=z(a);this.f.get(a,function(a,d){var e;if(d&&d.v){if(a=Uint8Array.from(d.v),d=[],0===a.length%r){var h=0;for(e=a.length/r;h<e;++h){var g=h;d.push(a.subarray(g*r,(g+1)*r))}b(d)}}else c()})};c.destroy=function(a){this.f.destroy(a);delete this.f};Object.defineProperty(t.prototype,"constructor",{enumerable:!1,value:t});w.prototype=Object.create(C.prototype);c=w.prototype;c.process_packet=function(a,b){this.a.process_packet(a,
b)};c.construct_routing_path=function(a){var b=this;a=a.slice();return new Promise(function(c){function e(d,l,y){function u(){function d(a,c,e){if(k===a.join(",")&&x===c.join(",")){b.a.off("extend_response",d);clearTimeout(z);e.length||m();try{f[r].put_handshake_message(e)}catch(T){m()}f[r].ready()||m();n[r]=f[r].get_rewrapper_keys().map(g.Rewrapper);b.a.confirm_extended_path(h,p);u()}}var e;a.length?(b.a.on("extend_response",d),w=a.shift(),r=w.join(","),(e=g.convert_public_key(w))||m(),f[r]=g.Encryptor(!0,
e),z=setTimeout(function(){b.a.off("extend_response",d);m()},1E3*L),b.a.extend_request(h,p,w,f[r].get_handshake_message())):(b.w.set(t,[h,p]),c(p))}var w,r,z;if(k===d.join(",")&&x===l.join(",")){clearTimeout(v);b.a.off("create_response",e);try{f[k].put_handshake_message(y)}catch(S){m()}f[k].ready()||m();n[k]=f[k].get_rewrapper_keys().map(g.Rewrapper);b.a.confirm_outgoing_segment_established(h,p);b.h.set(t,q.Multiplexer(A,b.o));b.c.set(t,q.Demultiplexer(A,b.o));u()}}var d;var l=a[a.length-1];var h=
a.shift();var k=h.join(",");var f=Object.create(null);var n=Object.create(null);var m=function(){b.u(h,p);throw Error("Routing path creation failed");};(d=g.convert_public_key(h))||m();f[k]=g.Encryptor(!0,d);b.a.on("create_response",e);var v=setTimeout(function(){b.a.off("create_response",e);m()},1E3*L);var p=b.a.create_request(h,f[k].get_handshake_message());var x=p.join(",");var t=u(h,p);b.g.set(t,f);b.l.set(t,n);b.j.set(t,l)})};c.destroy_routing_path=function(a,b){this.u(a,b)};c.send_data=function(a,
b,c,e){if(!(e.length>A)){var d=u(a,b);var g=this.j.get(d);if(d=this.h.get(d))for(d.feed(e);d.have_more_blocks();)e=d.get_block(),this.a.data(a,b,g,c,e)}};c.destroy=function(){var a=this;this.w.forEach(function(b){a.u(b[0],b[1])})};c.u=function(a,b){var c;a=u(a,b);if(b=this.g.get(a)){for(c in b){var e=b[c];e.destroy()}this.g["delete"](a);this.l["delete"](a);this.j["delete"](a);this.h["delete"](a);this.c["delete"](a);this.w["delete"](a)}};Object.defineProperty(w.prototype,"constructor",{enumerable:!1,
value:w});return{ready:g.ready,DHT:t,Router:w,MAX_DATA_SIZE:A}}var K=0;var I=1;var J=2;var E=10;var Q=0;var r=32;var R=16;var B=256;var L=10;var A=Math.pow(2,16)-1;var P=30;"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht ronion jssha/src/sha3 fixed-size-multiplexer async-eventer".split(" "),z):"object"===typeof exports?module.exports=z(require("@detox/crypto"),require("@detox/dht"),require("ronion"),require("jssha/src/sha3"),require("fixed-size-multiplexer"),require("async-eventer")):
this.detox_transport=z(this.detox_crypto,this.detox_dht,this.ronion,this.jsSHA,this.fixed_size_multiplexer,this.async_eventer)}).call(this);