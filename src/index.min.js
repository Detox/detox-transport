/*
 0BSD
*/
(function(){function t(e,l){e[0]=e[1];e[1]=e[2];e[2]=e[3];e[3]=e[4];e[4]=l}function m(e,m,p,u,w,x){function g(a,b,c,d,h,e){if(!(this instanceof g))return new g(a,b,c,d,h,e);p.call(this);this.B=a;this.h=b;this.A=d;this.j=e;this.D=1E3/h;this.o=m.Multiplexer(l,q);this.f=m.Demultiplexer(l,q);this.v=[f,f,f,f,f];this.u=[f,f,f,f,f];this.l(c)}function k(a,b,c,d,h){if(!(this instanceof k))return new k(a,b,c,d,h);p.call(this);this.j=a;this.a=v();this.c=v();this.g=new Set;this.h=b;this.o=c;this.l=d;this.m=h;
this.f=new WeakMap}var y=e.array2string;var z=e.string2array;var n=e.concat_arrays;var A=e.error_handler;var v=e.ArrayMap;var B=e.timeoutSet;var f=new Uint8Array(0);g.prototype={l:function(a){var b,c=this;if(!this.C){this.c=this.g=a;this.w=!1;var d=this.a;this.a=b=w({config:{iceServers:this.A},initiator:a,trickle:!1,wrtc:x});b.once("signal",function(d){c.b||c.a!==b||c.fire("signal",n([[a?1:0],z(d.sdp)]))});b.once("connect",function(){c.b||c.a!==b||(c.fire("connected"),c.off("signal"),c.C=!0,c.m=+new Date,
c.c&&c.s())});b.once("close",function(){c.a===b&&(c.fire("disconnected"),c.destroy())});b.on("data",function(a){if(!c.b)if(c.c||a.length!==q)c.destroy();else{for(c.f.feed(a);c.f.have_more_data();){var b=c.f.get_data();a=b[0];b=b.subarray(1);a<c.j&&(b=c.G(b));c.fire("data",a,b)}c.c=!0;c.s()}});b.on("error",A);d&&d.destroy()}},signal:function(a){var b,c,d;if(!this.b&&!this.w){this.w=!0;if((b=!!a[0])&&this.g)for(b=0,d=(c=this.B).length;b<d;++b){var h=b;var e=c[b];if(e!==this.h[h]){if(e>this.h[h])return;
this.l(!1);break}}else if(!b&&!this.g){this.destroy();return}this.a.signal({type:this.g?"answer":"offer",sdp:y(a.subarray(1))})}},update_peer_id:function(a){this.h=a},send:function(a,b){if(!(this.b||b.length>l)){if(a<this.j){if(b.length>r)return;b=this.F(b)}a=n([[a],b]);this.o.feed(a)}},destroy:function(){this.b||(this.b=!0,clearTimeout(this.i),this.a.destroy())},s:function(){var a=this;this.i=setTimeout(function(){if(!a.b)try{a.a.send(a.o.get_block()),a.c=!1,a.m=+new Date}catch(b){}},Math.max(0,
this.D-(new Date-this.m)))},F:function(a){var b=u.deflate(a,{dictionary:n(this.v),level:1});t(this.v,a);return b.length>r?n([[0],a]):n([[1],b])},G:function(a){var b;var c=a[0];a=a.subarray(1);c?b=u.inflate(a,{dictionary:n(this.u)}):b=a;t(this.u,b);return b}};g.prototype=Object.assign(Object.create(p.prototype),g.prototype);Object.defineProperty(g.prototype,"constructor",{value:g});k.prototype={create_connection:function(a,b){var c,d=this;if(this.b)return null;if(c=this.a.get(b)||this.c.get(b))return c;
c=g(this.j,b,a,this.h,this.o,this.l).on("data",function(a,b){if(!d.b){var e=d.f.get(c);d.fire("data",e,a,b)}}).once("signal",function(a){if(!d.b){var b=d.f.get(c);d.fire("signal",b,a);d.i(c,"connected")}}).once("connected",function(){var a=d.f.get(c);!d.b&&d.a.has(a)&&(d.a["delete"](a),d.c.set(a,c),d.fire("connected",a))}).once("disconnected",function(){if(!d.b){var a=d.f.get(c);d.a["delete"](a);d.c["delete"](a);d.fire("disconnected",a)}});this.f.set(c,b);this.i(c,"signal");this.a.set(b,c);return c},
get_connection:function(a){return this.a.get(a)||this.c.get(a)||null},update_peer_id:function(a,b){var c;return this.a.has(b)||this.c.has(b)?!1:(c=this.a.get(a))?(this.f.set(c,b),this.a["delete"](a),this.a.set(b,c),c.update_peer_id(b),!0):(c=this.c.get(a))?(this.f.set(c,b),this.c["delete"](a),this.c.set(b,c),c.update_peer_id(b),!0):!1},i:function(a,b){var c=this;var d=B(this.m,function(){a.destroy()});this.g.add(d);a.once(b,function(){c.g["delete"](d);clearTimeout(d)})},destroy_connection:function(a){(a=
this.a.get(a)||this.c.get(a))&&a.destroy()},signal:function(a,b){this.b||(a=this.a.get(a))&&a.signal(b)},send:function(a,b,c){this.b||(a=this.c.get(a))&&a.send(b,c)},destroy:function(){this.b||(this.b=!0,this.a.forEach(function(a){a.destroy()}),this.c.forEach(function(a){a.destroy()}),this.g.forEach(function(a){clearTimeout(a)}))}};k.prototype=Object.assign(Object.create(p.prototype),k.prototype);Object.defineProperty(k.prototype,"constructor",{value:k});return{P2P_transport:g,Transport:k,MAX_DATA_SIZE:l,
MAX_COMPRESSED_DATA_SIZE:r}}var l=Math.pow(2,16)-2;var r=l-1;var q=512;"function"===typeof define&&define.amd?define(["@detox/utils","fixed-size-multiplexer","async-eventer","pako","@detox/simple-peer"],m):"object"===typeof exports?module.exports=m(require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer"),require("pako"),require("@detox/simple-peer"),require("wrtc")):this.detox_transport=m(this.detox_utils,this.fixed_size_multiplexer,this.async_eventer,this.pako,this.SimplePeer)}).call(this);