/*
 0BSD
*/
(function(){function t(f,l){f[0]=f[1];f[1]=f[2];f[2]=f[3];f[3]=f[4];f[4]=l}function m(f,m,p,u,w,x){function h(a,b,d,c){var e=this;if(!(this instanceof h))return new h(a,b,d,c);p.call(this);this.s=a;this.h=c;this.b=w({config:{iceServers:b},initiator:a,trickle:!1,wrtc:x});this.u=1E3/d;this.c=a;this.j=m.Multiplexer(l,q);this.f=m.Demultiplexer(l,q);this.o=[g,g,g,g,g];this.m=[g,g,g,g,g];a=this.b;a.once("signal",function(a){e.a||e.fire("signal",y(a.sdp))});a.once("connect",function(){e.a||(e.fire("connected"),
e.i=+new Date,e.c&&e.l())});a.once("close",function(){e.fire("disconnected")});a.on("data",function(a){if(!e.a)if(e.c||a.length!==q)e.destroy();else{for(e.f.feed(a);e.f.have_more_data();){var b=e.f.get_data();a=b[0];b=b.subarray(1);a<e.h&&(b=e.w(b));e.fire("data",a,b)}e.c=!0;e.l()}})}function k(a,b,d,c){if(!(this instanceof k))return new k(a,b,d,c);p.call(this);this.b=v();this.c=v();this.f=new Set;this.j=a;this.l=b;this.h=d;this.i=c}var z=f.array2string;var y=f.string2array;var n=f.concat_arrays;
var v=f.ArrayMap;var A=f.timeoutSet;var g=new Uint8Array(0);h.prototype={signal:function(a){this.a||this.b.signal({type:this.s?"answer":"offer",sdp:z(a)})},send:function(a,b){if(!(this.a||b.length>l)){if(a<this.h){if(b.length>r)return;b=this.v(b)}a=n([[a],b]);this.j.feed(a)}},destroy:function(){this.a||(this.a=!0,clearTimeout(this.g),this.b.destroy())},l:function(){var a=this;this.g=setTimeout(function(){if(!a.a)try{a.b.send(a.j.get_block()),a.c=!1,a.i=+new Date}catch(b){}},Math.max(0,this.u-(new Date-
this.i)))},v:function(a){var b=u.deflate(a,{dictionary:n(this.o),level:1});t(this.o,a);return b.length>r?n([[0],a]):n([[1],b])},w:function(a){var b;var d=a[0];a=a.subarray(1);d?b=u.inflate(a,{dictionary:n(this.m)}):b=a;t(this.m,b);return b}};h.prototype=Object.assign(Object.create(p.prototype),h.prototype);Object.defineProperty(h.prototype,"constructor",{value:h});k.prototype={create_connection:function(a,b){var d,c=this;if(this.a)return null;if(d=this.b.get(b)||this.c.get(b))return d;d=h(a,this.j,
this.l,this.h).on("data",function(a,d){c.a||c.fire("data",b,a,d)}).once("signal",function(a){c.a||(c.fire("signal",b,a),c.g(d,"connected"))}).once("connected",function(){!c.a&&c.b.has(b)&&(c.b["delete"](b),c.c.set(b,d),c.fire("connected",b))}).once("disconnected",function(){c.a||(c.b["delete"](b),c.c["delete"](b),c.fire("disconnected",b))});this.g(d,"signal");this.b.set(b,d);return d},g:function(a,b){var d=this;var c=A(this.i,function(){a.destroy()});this.f.add(c);a.once(b,function(){d.f["delete"](c);
clearTimeout(c)})},destroy_connection:function(a){(a=this.b.get(a)||this.c.get(a))&&a.destroy()},signal:function(a,b){this.a||(a=this.b.get(a))&&a.signal(b)},send:function(a,b,d){this.a||(a=this.c.get(a))&&a.send(b,d)},destroy:function(){this.a||(this.a=!0,this.b.forEach(function(a){a.destroy()}),this.c.forEach(function(a){a.destroy()}),this.f.forEach(function(a){clearTimeout(a)}))}};k.prototype=Object.assign(Object.create(p.prototype),k.prototype);Object.defineProperty(k.prototype,"constructor",
{value:k});return{P2P_transport:h,Transport:k,MAX_DATA_SIZE:l,MAX_COMPRESSED_DATA_SIZE:r}}var l=Math.pow(2,16)-2;var r=l-1;var q=512;"function"===typeof define&&define.amd?define(["@detox/utils","fixed-size-multiplexer","async-eventer","pako","@detox/simple-peer"],m):"object"===typeof exports?module.exports=m(require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer"),require("pako"),require("@detox/simple-peer"),require("wrtc")):this.detox_transport=m(this.detox_utils,this.fixed_size_multiplexer,
this.async_eventer,this.pako,this.SimplePeer)}).call(this);