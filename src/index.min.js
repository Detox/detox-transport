/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(){function D(k){var c;var p="";var l=0;for(c=k.length;l<c;++l){var m=k[l];p+=m.toString(16).padStart(2,"0")}return p}function G(k){var c;var p=new Uint8Array(k.length/2);var l=0;for(c=p.length;l<c;++l){var m=l;p[m]=parseInt(k.substring(2*m,2*m+2),16)}return p}function H(k){var c;var p=new Uint8Array(k.length);var l=0;for(c=k.length;l<c;++l){var m=l;p[m]=k.charCodeAt(m)}return p}function u(k,c){return k.join(",")+c.join(",")}function z(k,c,p,l,m,B){function y(a){var b=this;if(!(this instanceof
y))return new y(a);this.G=a.sign;this.i=a.packets_per_second;this.o=a.initiator;this.once("connect",function(){b.F=1E3/b.i;b.h=m.Multiplexer(A,C);b.c=m.Demultiplexer(A,C);b.A=+new Date;b.o&&b.B()});n.call(this,a)}function z(a){var b=new l("SHA3-256","ARRAYBUFFER");b.update(a);return v.from(b.getHash("ARRAYBUFFER"))}function r(a,b,e,c,d,t){var f=this;null==t&&(t=2);if(!(this instanceof r))return new r(a,b,e,c,d,t);B.call(this);1>d&&(d=1);this.i=new Map;c=this.b=M({simple_peer_constructor:y,simple_peer_opts:{config:{iceServers:c},
packets_per_second:d,sign:function(d){return k.sign(d,a,b)}}});c.on("websocket_peer_connection_alias",function(a,b,d){e.forEach(function(e){if(e.host===a&&e.port===b)return f.i.set(d,e.node_id),d.on("close",function(){f.i["delete"](d)})})});c.on("node_connected",function(a){var b=G(a);var d=f.b.get_id_mapping(a);if(f.i.has(d)){var e=f.i.get(d);f.i["delete"](d);if(e!==a){d.destroy();return}}k.verify(d.H,d.D,b)?(d.on("custom_data",function(d,e){switch(d){case I:f.b.add_tag(a,"detox-responder");f.fire("node_tagged",
b);break;case J:f.b.del_tag(a,"detox-responder");f.fire("node_untagged",b);break;default:d<E||f.fire("data",b,d-E,e)}}),f.fire("node_connected",b)):d.destroy()});c.on("node_disconnected",function(a){f.fire("node_disconnected",G(a))});t=this.f=new N({bootstrap:e,hash:z,k:t,nodeId:v.from(a),socket:this.b,timeout:1E3*O,verify:k.verify});t.on("error",function(a){f.fire("error",a)});t.once("ready",function(){f.fire("ready")})}function w(a,b){var e=this;null==b&&(b=10);if(!(this instanceof w))return new w(a,
b);B.call(this);var c=C-3;this.g=new Map;this.l=new Map;this.j=new Map;this.h=new Map;this.c=new Map;this.u=new Map;this.a=p(P,c,q,Q,b).on("activity",function(a,b){e.fire("activity",a,b)}).on("create_request",function(b,c,f){var d=u(b,c);if(!e.g.has(d)){var h=k.Encryptor(!1,a);try{h.put_handshake_message(f)}catch(x){return}e.a.create_response(b,c,h.get_handshake_message());e.a.confirm_incoming_segment_established(b,c);e.h.set(d,m.Multiplexer(A,e.m));e.c.set(d,m.Demultiplexer(A,e.m));if(h.ready()){c=
h.get_rewrapper_keys().map(k.Rewrapper);f=b.join(",");var t=Object.create(null);t[f]=h;h=Object.create(null);h[f]=c;e.g.set(d,t);e.l.set(d,h);e.j.set(d,b)}}}).on("send",function(a,b){e.fire("send",a,b)}).on("data",function(a,b,f,c,h){var d=u(a,b);var t=e.j.get(d);f.join(",")===t.join(",")&&(f=e.c.get(d))&&(f.feed(h),f.have_more_data()&&(h=f.get_data(),e.fire("data",a,b,c,h)))}).on("encrypt",function(a){var b;var d=a.address;var c=a.segment_id;var h=a.target_address;var g=a.plaintext;d=u(d,c);h=h.join(",");
(h=null!=(b=e.g.get(d))?b[h]:void 0)&&(a.ciphertext=h.encrypt(g))}).on("decrypt",function(a){var b;var d=a.address;var c=a.segment_id;var h=a.target_address;var g=a.ciphertext;d=u(d,c);h=h.join(",");if(h=null!=(b=e.g.get(d))?b[h]:void 0)try{a.plaintext=h.decrypt(g)}catch(x){}}).on("wrap",function(a){var b,d;var c=a.address;var h=a.segment_id;var g=a.target_address;var k=a.unwrapped;c=u(c,h);g=g.join(",");(g=null!=(b=e.l.get(c))?null!=(d=b[g])?d[0]:void 0:void 0)&&(a.wrapped=g.wrap(k))}).on("unwrap",
function(a){var b,c;var d=a.address;var h=a.segment_id;var g=a.target_address;var k=a.wrapped;d=u(d,h);g=g.join(",");(g=null!=(b=e.l.get(d))?null!=(c=b[g])?c[1]:void 0:void 0)&&(a.unwrapped=g.unwrap(k))});this.m=this.a.get_max_command_data_length()}var F=c.bencode;var n=c["simple-peer"];var M=c["webrtc-socket"];var N=c["webtorrent-dht"];var v=c.Buffer;y.prototype=Object.create(n.prototype);c=y.prototype;c.emit=function(a,b){switch(a){case "signal":b.signature=v.from(this.G(H(b.sdp)));n.prototype.emit.call(this,
"signal",b);break;case "data":if(this.o)this.destroy();else if(b.length!==C)this.destroy();else{for(this.c.feed(b);this.c.have_more_data();){var c=this.c.get_data();var g=c[0];g===K?n.prototype.emit.call(this,"data",v.from(c.subarray(1))):n.prototype.emit.call(this,"custom_data",g,c.subarray(1))}this.o=!0;this.B()}break;default:n.prototype.emit.apply(this,arguments)}};c.signal=function(a){a.signature?(this.H=a.signature,this.D=H(a.sdp),n.prototype.signal.call(this,a)):this.destroy()};c.send=function(a){this.C(a,
K)};c.w=function(a,b){this.C(a,b)};c.C=function(a,b){var c;var g=c=new Uint8Array(a.length+1);g.set([b]);g.set(a,1);this.h.feed(c)};c.B=function(){var a=this;setTimeout(function(){a.destroyed||(n.prototype.send.call(a,a.h.get_block()),a.o=!1,a.A=+new Date)},Math.max(0,this.F-(new Date-this.A)))};Object.defineProperty(y.prototype,"constructor",{enumerable:!1,value:y});r.prototype=Object.create(B.prototype);c=r.prototype;c.start_bootstrap_node=function(a,b){this.f.listen(b,a)};c.get_bootstrap_nodes=
function(){var a,b,c=[];for(a in b=this.f._rpc.socket.socket._peer_connections){var g=b[a];g.ws_server&&g.id&&c.push({node_id:g.id,host:g.ws_server.host,port:g.ws_server.port})}return c.filter(Boolean)};c.lookup=function(a){this.f.lookup(v.from(a))};c.add_used_tag=function(a){var b;a=D(a);if(b=this.b.get_id_mapping(a))b.w(new Uint8Array(0),I),this.b.add_tag(a,"detox-initiator")};c.del_used_tag=function(a){var b;a=D(a);if(b=this.b.get_id_mapping(a))b.w(new Uint8Array(0),J),this.b.del_tag(a,"detox-initiator")};
c.send_data=function(a,b,c){c.length>A||(a=this.b.get_id_mapping(D(a)))&&a.w(c,b+E)};c.generate_announcement_message=function(a,b,c){var g;var d=+new Date;var e=new Uint8Array(c.length*q);var f=0;for(g=c.length;f<g;++f){var m=f;var h=c[f];e.set(h,m*q)}c=F.encode({seq:d,v:v.from(e)}).slice(1,-1);b=k.sign(c,a,b);return Uint8Array.from(F.encode({k:v.from(a),seq:d,sig:v.from(b),v:v.from(e)}))};c.publish_announcement_message=function(a){try{a=F.decode(v.from(a))}catch(b){}a&&a.k&&a.seq&&a.sig&&a.v&&this.f.put(a)};
c.find_introduction_nodes=function(a,b,c){a=z(a);this.f.get(a,function(a,d){var e;if(d&&d.v){if(a=Uint8Array.from(d.v),d=[],0===a.length%q){var f=0;for(e=a.length/q;f<e;++f){var g=f;d.push(a.subarray(g*q,(g+1)*q))}b(d)}}else c()})};c.destroy=function(a){this.f.destroy(a);delete this.f};Object.defineProperty(r.prototype,"constructor",{enumerable:!1,value:r});w.prototype=Object.create(B.prototype);c=w.prototype;c.process_packet=function(a,b){this.a.process_packet(a,b)};c.construct_routing_path=function(a){var b=
this;a=a.slice();return new Promise(function(c){function g(d,e,t){function u(){function d(a,c,e){if(l===a.join(",")&&y===c.join(",")){b.a.off("extend_response",d);clearTimeout(z);e.length||x();try{h[q].put_handshake_message(e)}catch(S){x()}h[q].ready()||x();p[q]=h[q].get_rewrapper_keys().map(k.Rewrapper);b.a.confirm_extended_path(f,n);u()}}var e;a.length?(b.a.on("extend_response",d),w=a.shift(),q=w.join(","),(e=k.convert_public_key(w))||x(),h[q]=k.Encryptor(!0,e),z=setTimeout(function(){b.a.off("extend_response",
d);x()},1E3*L),b.a.extend_request(f,n,w,h[q].get_handshake_message())):(b.u.set(r,[f,n]),c(n))}var w,q,z;if(l===d.join(",")&&y===e.join(",")){clearTimeout(v);b.a.off("create_response",g);try{h[l].put_handshake_message(t)}catch(R){x()}h[l].ready()||x();p[l]=h[l].get_rewrapper_keys().map(k.Rewrapper);b.a.confirm_outgoing_segment_established(f,n);b.h.set(r,m.Multiplexer(A,b.m));b.c.set(r,m.Demultiplexer(A,b.m));u()}}var d;var e=a[a.length-1];var f=a.shift();var l=f.join(",");var h=Object.create(null);
var p=Object.create(null);var x=function(){b.s(f,n);throw Error("Routing path creation failed");};(d=k.convert_public_key(f))||x();h[l]=k.Encryptor(!0,d);b.a.on("create_response",g);var v=setTimeout(function(){b.a.off("create_response",g);x()},1E3*L);var n=b.a.create_request(f,h[l].get_handshake_message());var y=n.join(",");var r=u(f,n);b.g.set(r,h);b.l.set(r,p);b.j.set(r,e)})};c.destroy_routing_path=function(a,b){this.s(a,b)};c.send_data=function(a,b,c,g){if(!(g.length>A)){var d=u(a,b);var e=this.j.get(d);
if(d=this.h.get(d))for(d.feed(g);d.have_more_blocks();)g=d.get_block(),this.a.data(a,b,e,c,g)}};c.destroy=function(){var a=this;this.u.forEach(function(b){a.s(b[0],b[1])})};c.s=function(a,b){var c;a=u(a,b);if(b=this.g.get(a)){for(c in b){var g=b[c];g.destroy()}this.g["delete"](a);this.l["delete"](a);this.j["delete"](a);this.h["delete"](a);this.c["delete"](a);this.u["delete"](a)}};Object.defineProperty(w.prototype,"constructor",{enumerable:!1,value:w});return{ready:k.ready,DHT:r,Router:w,MAX_DATA_SIZE:A}}
var K=0;var I=1;var J=2;var E=10;var P=0;var q=32;var Q=16;var L=10;var A=Math.pow(2,16)-1;var C=512;var O=30;"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht ronion jssha/src/sha3 fixed-size-multiplexer async-eventer".split(" "),z):"object"===typeof exports?module.exports=z(require("@detox/crypto"),require("@detox/dht"),require("ronion"),require("jssha/src/sha3"),require("fixed-size-multiplexer"),require("async-eventer")):this.detox_transport=z(this.detox_crypto,this.detox_dht,
this.ronion,this.jsSHA,this.fixed_size_multiplexer,this.async_eventer)}).call(this);