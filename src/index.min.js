/*
 0BSD
*/
(function(){function F(e){var c;var h="";var q=0;for(c=e.length;q<c;++q){var m=e[q];h+=m.toString(16).padStart(2,"0")}return h}function H(e){var c;var h=new Uint8Array(e.length/2);var q=0;for(c=h.length;q<c;++q){var m=q;h[m]=parseInt(e.substring(2*m,2*m+2),16)}return h}function I(e){var c;var h=new Uint8Array(e.length);var q=0;for(c=e.length;q<c;++q){var m=q;h[m]=e.charCodeAt(m)}return h}function J(e){var c;var h=e.reduce(function(c,e){return c+e.length},0);var q=0;h=new Uint8Array(h);var m=0;for(c=
e.length;m<c;++m){var r=e[m];h.set(r,q);q+=r.length}return h}function K(e,c){e[0]=e[1];e[1]=e[2];e[2]=e[3];e[3]=e[4];e[4]=c}function r(e,c){return e.join(",")+c.join(",")}function B(e,c,h,q,m,D,B){function v(a){var b=this;if(!(this instanceof v))return new v(a);this.L=a.sign;this.K=1E3/a.packets_per_second;this.s=a.initiator;this.D=m.Multiplexer(y,E);this.u=m.Demultiplexer(y,E);this.I=[new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0)];this.G=[new Uint8Array(0),
new Uint8Array(0),new Uint8Array(0),new Uint8Array(0),new Uint8Array(0)];this.once("connect",function(){b.C=+new Date;b.s&&b.F()});w.call(this,a)}function L(a){var b=new q("SHA3-256","ARRAYBUFFER");b.update(a);return p.from(b.getHash("ARRAYBUFFER"))}function u(a,b,f,d,c,n){var k=this;null==n&&(n=2);if(!(this instanceof u))return new u(a,b,f,d,c,n);D.call(this);1>c&&(c=1);this.l=new Map;d=this.c=Q({simple_peer_constructor:v,simple_peer_opts:{config:{iceServers:d},packets_per_second:c,sign:function(d){return e.sign(d,
a,b)}}});d.on("websocket_peer_connection_alias",function(a,b,d){f.forEach(function(f){if(f.host===a&&f.port===b)return k.l.set(d,f.node_id),d.on("close",function(){k.l["delete"](d)})})});d.on("node_connected",function(a){var b=H(a);var d=k.c.get_id_mapping(a);if(k.l.has(d)){var f=k.l.get(d);k.l["delete"](d);if(f!==a){d.destroy();return}}e.verify(d.M,d.J,b)?(d.on("custom_data",function(d,f){switch(d){case M:k.c.add_tag(a,"detox-responder");k.fire("node_tagged",b);break;case N:k.c.del_tag(a,"detox-responder");
k.fire("node_untagged",b);break;default:d<G||k.fire("data",b,d-G,f)}}),k.fire("node_connected",b)):d.destroy()});d.on("node_disconnected",function(a){k.fire("node_disconnected",H(a))});n=this.f=new S({bootstrap:f,hash:L,k:n,nodeId:p.from(a),socket:this.c,timeout:1E3*T,verify:e.verify});n.on("error",function(a){k.fire("error",a)});n.once("ready",function(){k.fire("ready")})}function t(a,b){var f=this;null==b&&(b=10);if(!(this instanceof t))return new t(a,b);D.call(this);this.g=new Map;this.j=new Map;
this.h=new Map;this.o=new Map;this.m=new Map;this.A=new Map;this.b=h(U,x,V,b).on("activity",function(a,b){f.fire("activity",a,b)}).on("create_request",function(b,c,n){if(!f.a){var d=r(b,c);if(!f.g.has(d)){var g=e.Encryptor(!1,a);try{g.put_handshake_message(n)}catch(R){return}f.b.create_response(b,c,g.get_handshake_message());f.b.confirm_incoming_segment_established(b,c);f.o.set(d,m.Multiplexer(y,f.i));f.m.set(d,m.Demultiplexer(y,f.i));if(g.ready()){c=g.get_rewrapper_keys().map(e.Rewrapper);n=b.join(",");
var A=Object.create(null);A[n]=g;g=Object.create(null);g[n]=c;f.g.set(d,A);f.j.set(d,g);f.h.set(d,b)}}}}).on("send",function(a,b){f.fire("send",a,b)}).on("data",function(a,b,c,e,g){if(!f.a){var d=r(a,b);var n=f.h.get(d);c.join(",")===n.join(",")&&(c=f.m.get(d))&&(c.feed(g),c.have_more_data()&&(g=c.get_data(),f.fire("data",a,b,e,g)))}}).on("encrypt",function(a){var b;if(!f.a){var d=a.address;var c=a.segment_id;var g=a.target_address;var e=a.plaintext;d=r(d,c);g=g.join(",");(g=null!=(b=f.g.get(d))?
b[g]:void 0)&&g.ready()&&(a.ciphertext=g.encrypt(e))}}).on("decrypt",function(a){var b;if(!f.a){var d=a.address;var c=a.segment_id;var e=a.target_address;var l=a.ciphertext;d=r(d,c);e=e.join(",");if((e=null!=(b=f.g.get(d))?b[e]:void 0)&&e.ready())try{a.plaintext=e.decrypt(l)}catch(R){}}}).on("wrap",function(a){var b,d;if(!f.a){var c=a.address;var e=a.segment_id;var l=a.target_address;var m=a.unwrapped;c=r(c,e);l=l.join(",");(l=null!=(b=f.j.get(c))?null!=(d=b[l])?d[0]:void 0:void 0)&&(a.wrapped=l.wrap(m))}}).on("unwrap",
function(a){var b,c;if(!f.a){var d=a.address;var e=a.segment_id;var l=a.target_address;var m=a.wrapped;d=r(d,e);l=l.join(",");(l=null!=(b=f.j.get(d))?null!=(c=b[l])?c[1]:void 0:void 0)&&(a.unwrapped=l.unwrap(m))}});this.i=this.b.get_max_command_data_length()}var C=c.bencode;var w=c["simple-peer"];var Q=c["webrtc-socket"];var S=c["webtorrent-dht"];var p=c.Buffer;v.prototype=Object.create(w.prototype);c=v.prototype;c.emit=function(a,b){switch(a){case "signal":b.signature=p.from(this.L(I(b.sdp)));w.prototype.emit.call(this,
"signal",b);break;case "data":if(this.s)this.destroy();else if(b.length!==E)this.destroy();else{for(this.u.feed(b);this.u.have_more_data();){var c=this.u.get_data();var d=c[0];d===O?w.prototype.emit.call(this,"data",p.from(this.O(c.subarray(1)))):w.prototype.emit.call(this,"custom_data",d,c.subarray(1))}this.s=!0;this.F()}break;default:w.prototype.emit.apply(this,arguments)}};c.signal=function(a){if(a.signature){this.M=a.signature;this.J=I(a.sdp);try{w.prototype.signal.call(this,a)}catch(b){}}else this.destroy()};
c.send=function(a){this.H(this.N(a),O)};c.B=function(a,b){this.H(a,b)};c.H=function(a,b){var c;var d=c=new Uint8Array(a.length+1);d.set([b]);d.set(a,1);this.D.feed(c)};c.F=function(){var a=this;setTimeout(function(){a.destroyed||(w.prototype.send.call(a,a.D.get_block()),a.s=!1,a.C=+new Date)},Math.max(0,this.K-(new Date-this.C)))};c.N=function(a){var b=B.deflate(a,{dictionary:J(this.I),level:1});K(this.I,a);return b};c.O=function(a){a=B.inflate(a,{dictionary:J(this.G)});K(this.G,a);return a};Object.defineProperty(v.prototype,
"constructor",{enumerable:!1,value:v});u.prototype=Object.create(D.prototype);c=u.prototype;c.start_bootstrap_node=function(a,b){this.a||this.f.listen(b,a)};c.get_bootstrap_nodes=function(){if(this.a)var a=[];else{var b,c,d=[];for(b in c=this.f._rpc.socket.socket._peer_connections)a=c[b],a.ws_server&&a.id&&d.push({node_id:a.id,host:a.ws_server.host,port:a.ws_server.port});a=d.filter(Boolean)}return a};c.lookup=function(a){this.a||this.f.lookup(p.from(a))};c.add_used_tag=function(a){var b;!this.a&&
(a=F(a),b=this.c.get_id_mapping(a))&&(b.B(new Uint8Array(0),M),this.c.add_tag(a,"detox-initiator"))};c.del_used_tag=function(a){var b;!this.a&&(a=F(a),b=this.c.get_id_mapping(a))&&(b.B(new Uint8Array(0),N),this.c.del_tag(a,"detox-initiator"))};c.send_data=function(a,b,c){this.a||c.length>y||(a=this.c.get_id_mapping(F(a)))&&a.B(c,b+G)};c.generate_announcement_message=function(a,b,c){var d;var f=+new Date;var n=new Uint8Array(c.length*x);var k=0;for(d=c.length;k<d;++k){var g=k;var l=c[k];n.set(l,g*
x)}c=C.encode({seq:f,v:p.from(n)}).slice(1,-1);b=e.sign(c,a,b);return Uint8Array.from(C.encode({k:p.from(a),seq:f,sig:p.from(b),v:p.from(n)}))};c.verify_announcement_message=function(a){try{a=C.decode(p.from(a))}catch(f){}if(!(a&&a.k&&a.seq&&a.sig&&a.v))return null;var b=C.encode({seq:a.seq,v:a.v}).slice(1,-1);return e.verify(a.sig,b,a.k)?Uint8Array.from(a.k):null};c.publish_announcement_message=function(a){!this.a&&this.verify_announcement_message(a)&&this.f.put(C.decode(p.from(a)))};c.find_introduction_nodes=
function(a,b,c){this.a||(a=L(a),this.f.get(a,function(a,e){var d;if(e&&e.v){if(a=Uint8Array.from(e.v),e=[],0===a.length%x){var f=0;for(d=a.length/x;f<d;++f){var g=f;e.push(a.subarray(g*x,(g+1)*x))}b(e)}}else c()}))};c.destroy=function(a){this.f.destroy(a);delete this.f;this.a=!0};Object.defineProperty(u.prototype,"constructor",{enumerable:!1,value:u});t.prototype=Object.create(D.prototype);c=t.prototype;c.process_packet=function(a,b){this.a||this.b.process_packet(a,b)};c.construct_routing_path=function(a){var b=
this;if(this.a)return Promise.reject();a=a.slice();return new Promise(function(c,d){function f(d,n,k){function r(){function d(a,c,f){if(l===a.join(",")&&v===c.join(","))if(b.b.off("extend_response",d),clearTimeout(x),f.length){try{h[t].put_handshake_message(f)}catch(X){p();return}h[t].ready()?(q[t]=h[t].get_rewrapper_keys().map(e.Rewrapper),b.b.confirm_extended_path(g,z),r()):p()}else p()}var f;a.length?(b.b.on("extend_response",d),A=a.shift(),t=A.join(","),(f=e.convert_public_key(A))?(h[t]=e.Encryptor(!0,
f),x=setTimeout(function(){b.b.off("extend_response",d);p()},1E3*P),b.b.extend_request(g,z,A,h[t].get_handshake_message())):p()):(b.A.set(u,[g,z]),c(z))}var A,t,x;if(l===d.join(",")&&v===n.join(",")){clearTimeout(w);b.b.off("create_response",f);try{h[l].put_handshake_message(k)}catch(W){p();return}h[l].ready()?(q[l]=h[l].get_rewrapper_keys().map(e.Rewrapper),b.b.confirm_outgoing_segment_established(g,z),b.o.set(u,m.Multiplexer(y,b.i)),b.m.set(u,m.Demultiplexer(y,b.i)),r()):p()}}var n;var k=a[a.length-
1];var g=a.shift();var l=g.join(",");var h=Object.create(null);var q=Object.create(null);var p=function(){b.w(g,z);d("Routing path creation failed")};if(n=e.convert_public_key(g)){h[l]=e.Encryptor(!0,n);b.b.on("create_response",f);var w=setTimeout(function(){b.b.off("create_response",f);p()},1E3*P);var z=b.b.create_request(g,h[l].get_handshake_message());var v=z.join(",");var u=r(g,z);b.g.set(u,h);b.j.set(u,q);b.h.set(u,k)}else p()})};c.destroy_routing_path=function(a,b){this.w(a,b)};c.get_max_packet_data_size=
function(){return this.i};c.send_data=function(a,b,c,d){if(!(this.a||d.length>y)){var e=r(a,b);var f=this.h.get(e);if(e=this.o.get(e))for(e.feed(d);e.have_more_blocks();)d=e.get_block(),this.b.data(a,b,f,c,d)}};c.destroy=function(){var a=this;this.a=!0;this.A.forEach(function(b){a.w(b[0],b[1])})};c.w=function(a,b){var c;a=r(a,b);if(b=this.g.get(a)){for(c in b){var d=b[c];d.destroy()}this.g["delete"](a);this.j["delete"](a);this.h["delete"](a);this.o["delete"](a);this.m["delete"](a);this.A["delete"](a)}};
Object.defineProperty(t.prototype,"constructor",{enumerable:!1,value:t});return{ready:e.ready,DHT:u,Router:t,MAX_DATA_SIZE:y}}var O=0;var M=1;var N=2;var G=10;var x=32;var V=16;var P=10;var y=Math.pow(2,16)-1;var E=512;var U=E-3;var T=30;"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht ronion jssha/src/sha3 fixed-size-multiplexer async-eventer pako".split(" "),B):"object"===typeof exports?module.exports=B(require("@detox/crypto"),require("@detox/dht"),require("ronion"),require("jssha/src/sha3"),
require("fixed-size-multiplexer"),require("async-eventer"),require("pako")):this.detox_transport=B(this.detox_crypto,this.detox_dht,this.ronion,this.jsSHA,this.fixed_size_multiplexer,this.async_eventer,this.pako)}).call(this);