/*
 Copyright (c) 2017, Nazar Mokrynskyi
 @license   MIT License, see license.txt
*/
(function(){function F(f){var c;var q="";var k=0;for(c=f.length;k<c;++k){var n=f[k];q+=n.toString(16).padStart(2,"0")}return q}function H(f){var c;var q=new Uint8Array(f.length/2);var k=0;for(c=q.length;k<c;++k){var n=k;q[n]=parseInt(f.substring(2*n,2*n+2),16)}return q}function I(f){var c;var q=new Uint8Array(f.length);var k=0;for(c=f.length;k<c;++k){var n=k;q[n]=f.charCodeAt(n)}return q}function u(f,c){return f.join(",")+c.join(",")}function B(f,c,q,k,n,D){function w(a){var b=this;if(!(this instanceof
w))return new w(a);this.J=a.sign;this.I=1E3/a.packets_per_second;this.s=a.initiator;this.D=n.Multiplexer(z,E);this.u=n.Demultiplexer(z,E);this.once("connect",function(){b.C=+new Date;b.s&&b.F()});x.call(this,a)}function B(a){var b=new k("SHA3-256","ARRAYBUFFER");b.update(a);return l.from(b.getHash("ARRAYBUFFER"))}function v(a,b,e,d,r,m){var h=this;null==m&&(m=2);if(!(this instanceof v))return new v(a,b,e,d,r,m);D.call(this);1>r&&(r=1);this.l=new Map;d=this.c=N({simple_peer_constructor:w,simple_peer_opts:{config:{iceServers:d},
packets_per_second:r,sign:function(d){return f.sign(d,a,b)}}});d.on("websocket_peer_connection_alias",function(a,b,d){e.forEach(function(e){if(e.host===a&&e.port===b)return h.l.set(d,e.node_id),d.on("close",function(){h.l["delete"](d)})})});d.on("node_connected",function(a){var b=H(a);var d=h.c.get_id_mapping(a);if(h.l.has(d)){var e=h.l.get(d);h.l["delete"](d);if(e!==a){d.destroy();return}}f.verify(d.K,d.H,b)?(d.on("custom_data",function(d,e){switch(d){case J:h.c.add_tag(a,"detox-responder");h.fire("node_tagged",
b);break;case K:h.c.del_tag(a,"detox-responder");h.fire("node_untagged",b);break;default:d<G||h.fire("data",b,d-G,e)}}),h.fire("node_connected",b)):d.destroy()});d.on("node_disconnected",function(a){h.fire("node_disconnected",H(a))});m=this.f=new O({bootstrap:e,hash:B,k:m,nodeId:l.from(a),socket:this.c,timeout:1E3*P,verify:f.verify});m.on("error",function(a){h.fire("error",a)});m.once("ready",function(){h.fire("ready")})}function t(a,b){var e=this;null==b&&(b=10);if(!(this instanceof t))return new t(a,
b);D.call(this);this.g=new Map;this.j=new Map;this.h=new Map;this.o=new Map;this.m=new Map;this.A=new Map;this.b=q(Q,y,R,b).on("activity",function(a,b){e.fire("activity",a,b)}).on("create_request",function(b,r,m){if(!e.a){var d=u(b,r);if(!e.g.has(d)){var g=f.Encryptor(!1,a);try{g.put_handshake_message(m)}catch(p){return}e.b.create_response(b,r,g.get_handshake_message());e.b.confirm_incoming_segment_established(b,r);e.o.set(d,n.Multiplexer(z,e.i));e.m.set(d,n.Demultiplexer(z,e.i));if(g.ready()){r=
g.get_rewrapper_keys().map(f.Rewrapper);m=b.join(",");var c=Object.create(null);c[m]=g;g=Object.create(null);g[m]=r;e.g.set(d,c);e.j.set(d,g);e.h.set(d,b)}}}}).on("send",function(a,b){e.fire("send",a,b)}).on("data",function(a,b,c,h,g){if(!e.a){var d=u(a,b);var r=e.h.get(d);c.join(",")===r.join(",")&&(c=e.m.get(d))&&(c.feed(g),c.have_more_data()&&(g=c.get_data(),e.fire("data",a,b,h,g)))}}).on("encrypt",function(a){var b;if(!e.a){var d=a.address;var c=a.segment_id;var g=a.target_address;var f=a.plaintext;
d=u(d,c);g=g.join(",");(g=null!=(b=e.g.get(d))?b[g]:void 0)&&g.ready()&&(a.ciphertext=g.encrypt(f))}}).on("decrypt",function(a){var b;if(!e.a){var d=a.address;var c=a.segment_id;var g=a.target_address;var f=a.ciphertext;d=u(d,c);g=g.join(",");if((g=null!=(b=e.g.get(d))?b[g]:void 0)&&g.ready())try{a.plaintext=g.decrypt(f)}catch(p){}}}).on("wrap",function(a){var b,d;if(!e.a){var c=a.address;var g=a.segment_id;var f=a.target_address;var p=a.unwrapped;c=u(c,g);f=f.join(",");(f=null!=(b=e.j.get(c))?null!=
(d=b[f])?d[0]:void 0:void 0)&&(a.wrapped=f.wrap(p))}}).on("unwrap",function(a){var b,d;if(!e.a){var c=a.address;var g=a.segment_id;var f=a.target_address;var p=a.wrapped;c=u(c,g);f=f.join(",");(f=null!=(b=e.j.get(c))?null!=(d=b[f])?d[1]:void 0:void 0)&&(a.unwrapped=f.unwrap(p))}});this.i=this.b.get_max_command_data_length()}var C=c.bencode;var x=c["simple-peer"];var N=c["webrtc-socket"];var O=c["webtorrent-dht"];var l=c.Buffer;w.prototype=Object.create(x.prototype);c=w.prototype;c.emit=function(a,
b){switch(a){case "signal":b.signature=l.from(this.J(I(b.sdp)));x.prototype.emit.call(this,"signal",b);break;case "data":if(this.s)this.destroy();else if(b.length!==E)this.destroy();else{for(this.u.feed(b);this.u.have_more_data();){var e=this.u.get_data();var d=e[0];d===L?x.prototype.emit.call(this,"data",l.from(e.subarray(1))):x.prototype.emit.call(this,"custom_data",d,e.subarray(1))}this.s=!0;this.F()}break;default:x.prototype.emit.apply(this,arguments)}};c.signal=function(a){if(a.signature){this.K=
a.signature;this.H=I(a.sdp);try{x.prototype.signal.call(this,a)}catch(b){}}else this.destroy()};c.send=function(a){this.G(a,L)};c.B=function(a,b){this.G(a,b)};c.G=function(a,b){var e;var d=e=new Uint8Array(a.length+1);d.set([b]);d.set(a,1);this.D.feed(e)};c.F=function(){var a=this;setTimeout(function(){a.destroyed||(x.prototype.send.call(a,a.D.get_block()),a.s=!1,a.C=+new Date)},Math.max(0,this.I-(new Date-this.C)))};Object.defineProperty(w.prototype,"constructor",{enumerable:!1,value:w});v.prototype=
Object.create(D.prototype);c=v.prototype;c.start_bootstrap_node=function(a,b){this.a||this.f.listen(b,a)};c.get_bootstrap_nodes=function(){if(this.a)var a=[];else{var b,e,d=[];for(b in e=this.f._rpc.socket.socket._peer_connections)a=e[b],a.ws_server&&a.id&&d.push({node_id:a.id,host:a.ws_server.host,port:a.ws_server.port});a=d.filter(Boolean)}return a};c.lookup=function(a){this.a||this.f.lookup(l.from(a))};c.add_used_tag=function(a){var b;!this.a&&(a=F(a),b=this.c.get_id_mapping(a))&&(b.B(new Uint8Array(0),
J),this.c.add_tag(a,"detox-initiator"))};c.del_used_tag=function(a){var b;!this.a&&(a=F(a),b=this.c.get_id_mapping(a))&&(b.B(new Uint8Array(0),K),this.c.del_tag(a,"detox-initiator"))};c.send_data=function(a,b,e){this.a||e.length>z||(a=this.c.get_id_mapping(F(a)))&&a.B(e,b+G)};c.generate_announcement_message=function(a,b,e){var d;var c=+new Date;var m=new Uint8Array(e.length*y);var h=0;for(d=e.length;h<d;++h){var g=h;var n=e[h];m.set(n,g*y)}e=C.encode({seq:c,v:l.from(m)}).slice(1,-1);b=f.sign(e,a,
b);return Uint8Array.from(C.encode({k:l.from(a),seq:c,sig:l.from(b),v:l.from(m)}))};c.verify_announcement_message=function(a){try{a=C.decode(l.from(a))}catch(e){}if(!(a&&a.k&&a.seq&&a.sig&&a.v))return null;var b=C.encode({seq:a.seq,v:a.v}).slice(1,-1);return f.verify(a.sig,b,a.k)?Uint8Array.from(a.k):null};c.publish_announcement_message=function(a){!this.a&&this.verify_announcement_message(a)&&this.f.put(C.decode(l.from(a)))};c.find_introduction_nodes=function(a,b,c){this.a||(a=B(a),this.f.get(a,
function(a,e){var d;if(e&&e.v){if(a=Uint8Array.from(e.v),e=[],0===a.length%y){var f=0;for(d=a.length/y;f<d;++f){var g=f;e.push(a.subarray(g*y,(g+1)*y))}b(e)}}else c()}))};c.destroy=function(a){this.f.destroy(a);delete this.f;this.a=!0};Object.defineProperty(v.prototype,"constructor",{enumerable:!1,value:v});t.prototype=Object.create(D.prototype);c=t.prototype;c.process_packet=function(a,b){this.a||this.b.process_packet(a,b)};c.construct_routing_path=function(a){var b=this;if(this.a)return Promise.reject();
a=a.slice();return new Promise(function(e,d){function c(d,h,m){function r(){function d(a,c,e){if(k===a.join(",")&&w===c.join(","))if(b.b.off("extend_response",d),clearTimeout(y),e.length){try{p[t].put_handshake_message(e)}catch(T){l();return}p[t].ready()?(q[t]=p[t].get_rewrapper_keys().map(f.Rewrapper),b.b.confirm_extended_path(g,A),r()):l()}else l()}var c;a.length?(b.b.on("extend_response",d),u=a.shift(),t=u.join(","),(c=f.convert_public_key(u))?(p[t]=f.Encryptor(!0,c),y=setTimeout(function(){b.b.off("extend_response",
d);l()},1E3*M),b.b.extend_request(g,A,u,p[t].get_handshake_message())):l()):(b.A.set(v,[g,A]),e(A))}var u,t,y;if(k===d.join(",")&&w===h.join(",")){clearTimeout(x);b.b.off("create_response",c);try{p[k].put_handshake_message(m)}catch(S){l();return}p[k].ready()?(q[k]=p[k].get_rewrapper_keys().map(f.Rewrapper),b.b.confirm_outgoing_segment_established(g,A),b.o.set(v,n.Multiplexer(z,b.i)),b.m.set(v,n.Demultiplexer(z,b.i)),r()):l()}}var m;var h=a[a.length-1];var g=a.shift();var k=g.join(",");var p=Object.create(null);
var q=Object.create(null);var l=function(){b.w(g,A);d("Routing path creation failed")};if(m=f.convert_public_key(g)){p[k]=f.Encryptor(!0,m);b.b.on("create_response",c);var x=setTimeout(function(){b.b.off("create_response",c);l()},1E3*M);var A=b.b.create_request(g,p[k].get_handshake_message());var w=A.join(",");var v=u(g,A);b.g.set(v,p);b.j.set(v,q);b.h.set(v,h)}else l()})};c.destroy_routing_path=function(a,b){this.w(a,b)};c.get_max_packet_data_size=function(){return this.i};c.send_data=function(a,
b,c,d){if(!(this.a||d.length>z)){var e=u(a,b);var f=this.h.get(e);if(e=this.o.get(e))for(e.feed(d);e.have_more_blocks();)d=e.get_block(),this.b.data(a,b,f,c,d)}};c.destroy=function(){var a=this;this.a=!0;this.A.forEach(function(b){a.w(b[0],b[1])})};c.w=function(a,b){var c;a=u(a,b);if(b=this.g.get(a)){for(c in b){var d=b[c];d.destroy()}this.g["delete"](a);this.j["delete"](a);this.h["delete"](a);this.o["delete"](a);this.m["delete"](a);this.A["delete"](a)}};Object.defineProperty(t.prototype,"constructor",
{enumerable:!1,value:t});return{ready:f.ready,DHT:v,Router:t,MAX_DATA_SIZE:z}}var L=0;var J=1;var K=2;var G=10;var y=32;var R=16;var M=10;var z=Math.pow(2,16)-1;var E=512;var Q=E-3;var P=30;"function"===typeof define&&define.amd?define("@detox/crypto @detox/dht ronion jssha/src/sha3 fixed-size-multiplexer async-eventer".split(" "),B):"object"===typeof exports?module.exports=B(require("@detox/crypto"),require("@detox/dht"),require("ronion"),require("jssha/src/sha3"),require("fixed-size-multiplexer"),
require("async-eventer")):this.detox_transport=B(this.detox_crypto,this.detox_dht,this.ronion,this.jsSHA,this.fixed_size_multiplexer,this.async_eventer)}).call(this);