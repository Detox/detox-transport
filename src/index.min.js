/*
 0BSD
*/
(function(){function t(f,l){f[0]=f[1];f[1]=f[2];f[2]=f[3];f[3]=f[4];f[4]=l}function m(f,m,p,u,w,x){function h(a,b,c,d){var e=this;if(!(this instanceof h))return new h(a,b,c,d);p.call(this);this.s=a;this.g=d;this.a=w({config:{iceServers:b},initiator:a,trickle:!1,wrtc:x});this.u=1E3/c;this.c=a;this.j=m.Multiplexer(l,q);this.f=m.Demultiplexer(l,q);this.o=[g,g,g,g,g];this.m=[g,g,g,g,g];a=this.a;a.once("signal",function(a){e.b||e.fire("signal",y(a.sdp))});a.once("connect",function(){e.b||(e.fire("connected"),
e.i=+new Date,e.c&&e.l())});a.once("close",function(){e.fire("disconnected");e.destroy()});a.on("data",function(a){if(!e.b)if(e.c||a.length!==q)e.destroy();else{for(e.f.feed(a);e.f.have_more_data();){var b=e.f.get_data();a=b[0];b=b.subarray(1);a<e.g&&(b=e.w(b));e.fire("data",a,b)}e.c=!0;e.l()}})}function k(a,b,c,d){if(!(this instanceof k))return new k(a,b,c,d);p.call(this);this.a=v();this.c=v();this.g=new Set;this.l=a;this.m=b;this.i=c;this.j=d;this.f=new WeakMap}var z=f.array2string;var y=f.string2array;
var n=f.concat_arrays;var v=f.ArrayMap;var A=f.timeoutSet;var g=new Uint8Array(0);h.prototype={signal:function(a){this.b||this.a.signal({type:this.s?"answer":"offer",sdp:z(a)})},send:function(a,b){if(!(this.b||b.length>l)){if(a<this.g){if(b.length>r)return;b=this.v(b)}a=n([[a],b]);this.j.feed(a)}},destroy:function(){this.b||(this.b=!0,clearTimeout(this.h),this.a.destroy())},l:function(){var a=this;this.h=setTimeout(function(){if(!a.b)try{a.a.send(a.j.get_block()),a.c=!1,a.i=+new Date}catch(b){}},
Math.max(0,this.u-(new Date-this.i)))},v:function(a){var b=u.deflate(a,{dictionary:n(this.o),level:1});t(this.o,a);return b.length>r?n([[0],a]):n([[1],b])},w:function(a){var b;var c=a[0];a=a.subarray(1);c?b=u.inflate(a,{dictionary:n(this.m)}):b=a;t(this.m,b);return b}};h.prototype=Object.assign(Object.create(p.prototype),h.prototype);Object.defineProperty(h.prototype,"constructor",{value:h});k.prototype={create_connection:function(a,b){var c,d=this;if(this.b)return null;if(c=this.a.get(b)||this.c.get(b))return c;
c=h(a,this.l,this.m,this.i).on("data",function(a,b){if(!d.b){var e=d.f.get(c);d.fire("data",e,a,b)}}).once("signal",function(a){if(!d.b){var b=d.f.get(c);d.fire("signal",b,a);d.h(c,"connected")}}).once("connected",function(){var a=d.f.get(c);!d.b&&d.a.has(a)&&(d.a["delete"](a),d.c.set(a,c),d.fire("connected",a))}).once("disconnected",function(){if(!d.b){var a=d.f.get(c);d.a["delete"](a);d.c["delete"](a);d.fire("disconnected",a)}});this.f.set(c,b);this.h(c,"signal");this.a.set(b,c);return c},update_peer_id:function(a,
b){var c;return this.a.has(b)||this.c.has(b)?!1:(c=this.a.get(a))?(this.f.set(c,b),this.a["delete"](a),this.a.set(b,c),!0):(c=this.c.get(a))?(this.f.set(c,b),this.c["delete"](a),this.c.set(b,c),!0):!1},h:function(a,b){var c=this;var d=A(this.j,function(){a.destroy()});this.g.add(d);a.once(b,function(){c.g["delete"](d);clearTimeout(d)})},destroy_connection:function(a){(a=this.a.get(a)||this.c.get(a))&&a.destroy()},signal:function(a,b){this.b||(a=this.a.get(a))&&a.signal(b)},send:function(a,b,c){this.b||
(a=this.c.get(a))&&a.send(b,c)},destroy:function(){this.b||(this.b=!0,this.a.forEach(function(a){a.destroy()}),this.c.forEach(function(a){a.destroy()}),this.g.forEach(function(a){clearTimeout(a)}))}};k.prototype=Object.assign(Object.create(p.prototype),k.prototype);Object.defineProperty(k.prototype,"constructor",{value:k});return{P2P_transport:h,Transport:k,MAX_DATA_SIZE:l,MAX_COMPRESSED_DATA_SIZE:r}}var l=Math.pow(2,16)-2;var r=l-1;var q=512;"function"===typeof define&&define.amd?define(["@detox/utils",
"fixed-size-multiplexer","async-eventer","pako","@detox/simple-peer"],m):"object"===typeof exports?module.exports=m(require("@detox/utils"),require("fixed-size-multiplexer"),require("async-eventer"),require("pako"),require("@detox/simple-peer"),require("wrtc")):this.detox_transport=m(this.detox_utils,this.fixed_size_multiplexer,this.async_eventer,this.pako,this.SimplePeer)}).call(this);